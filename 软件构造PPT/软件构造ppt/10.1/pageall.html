<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head> <body onload="start()"><div style="background:#5c5c5f; color:#FFF"> <p align="center">&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;[&#x6DF1;&#x5BB9;Pubmed&#x6587;&#x732E;&#x68C0;&#x7D22;] &nbsp 1. &#x6B64;&#x5904;&#x53F3;&#x952E;&#xFF1A;&#x9009;&#x83DC;&#x5355;&#x3010;&#x7FFB;&#x6210;&#x4E2D;&#x6587;&#xFF08;&#x7B80;&#x4F53;&#xFF09;&#x3011; &nbsp &nbsp &nbsp  2. &#x7FFB;&#x8BD1;&#x540E;&#xFF0C;&#x6B64;&#x5904;&#x53F3;&#x952E;&#xFF1A;&#x9009;&#x83DC;&#x5355;&#x3010;&#x6253;&#x5370;...&#x3011;&#x6210;PDF&#x683C;&#x5F0F; <br>&#x5EFA;&#x8BAE;&#x5C4F;&#x5E55;&#x5206;&#x8FA8;&#x7387;&#xFF1A;1920X1080&#xFF1B;&#x5982;&#x679C;&#x5C4F;&#x5E55;&#x592A;&#x5C0F;&#xFF0C;&#x53EF;&#x4EE5;&#x6309;Ctrl + &#x6216; Ctrl -&#x7F29;&#x653E;&#x7F51;&#x9875;&#x3002;</p></div><style type="text/css"> .txt { white-space:nowrap; }	 #f0 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f1 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f2 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f3 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f4 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f5 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f6 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f7 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f8 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f9 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f10 { font-family:sans-serif; font-weight:normal; font-style:normal; }  #f11 { font-family:sans-serif; font-weight:normal; font-style:normal; }  #f12 { font-family:sans-serif; font-weight:normal; font-style:normal; } 	#f13 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f14 { font-family:sans-serif; font-weight:normal; font-style:normal; } #f15 { font-family:sans-serif; font-weight:normal; font-style:normal; } 	#f16 { font-family:sans-serif; font-weight:normal; font-style:normal; }	 #f17 { font-family:sans-serif; font-weight:normal; font-style:normal; } #f18 { font-family:sans-serif; font-weight:normal; font-style:normal; } #f19 { font-family:sans-serif; font-weight:normal; font-style:normal; }		#f20 { font-family:sans-serif; font-weight:normal; font-style:normal; }		</style><img id="background" style="position:absolute; left:0px; top:50px;" width="1440" height="1080" src="page1.png"> <img id="background" style="position:absolute; left:1440px; top:50px;" width="1440" height="1080" src="page-000001.png">
<div class="txt" style="position:absolute; left:1105px; top:68px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:225px; top:361px;"><span id="f9" style="font-size:55px;vertical-align:baseline;color:rgba(0,0,0,1);">Chapter 10: Concurrent and Distributed</span></div>
<div class="txt" style="position:absolute; left:546px; top:429px;"><span id="f9" style="font-size:55px;vertical-align:baseline;color:rgba(0,0,0,1);">Programming</span></div>
<div class="txt" style="position:absolute; left:123px; top:500px;"><span id="f17" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:596px; top:719px;"><span id="f9" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Xu Hanchuan</span></div>
<div class="txt" style="position:absolute; left:585px; top:772px;"><span id="f9" style="font-size:40px;vertical-align:baseline;color:rgba(255,98,176,1);">xhc@hit.edu.cn</span></div>
<div class="txt" style="position:absolute; left:604px; top:877px;"><span id="f9" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">May 21, 2019</span></div>
<img id="background" style="position:absolute; left:0px; top:1050px;" width="1440" height="1080" src="page2.png"> <img id="background" style="position:absolute; left:1440px; top:1050px;" width="1440" height="1080" src="page-000002.png">
<div class="txt" style="position:absolute; left:33px; top:1152px;"><span id="f12" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">课程章节安排</span></div>
<div class="txt" style="position:absolute; left:149px; top:1426px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第一章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(4</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:152px; top:1468px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">软件构造基础</span></div>
<div class="txt" style="position:absolute; left:297px; top:1568px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">实验</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">1</span></div>
<div class="txt" style="position:absolute; left:149px; top:1653px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第二章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(4</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:152px; top:1695px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">软件构造过程</span></div>
<div class="txt" style="position:absolute; left:158px; top:1944px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">实验</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(28</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:899px; top:1068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:748px; top:1253px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">实验</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">2</span></div>
<div class="txt" style="position:absolute; left:594px; top:1313px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第三章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(12</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:625px; top:1359px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">ADT+OOP</span></div>
<div class="txt" style="position:absolute; left:603px; top:1518px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第五章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(6</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:552px; top:1560px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">面向可复用性的构造</span></div>
<div class="txt" style="position:absolute; left:773px; top:1644px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">实验</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">3</span></div>
<div class="txt" style="position:absolute; left:603px; top:1721px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第六章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(6</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:552px; top:1763px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">面向可维护性的构造</span></div>
<div class="txt" style="position:absolute; left:603px; top:1923px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第七章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(8</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:570px; top:1965px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">面向健壮性的构造</span></div>
<div class="txt" style="position:absolute; left:773px; top:2041px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">实验</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">4</span></div>
<div class="txt" style="position:absolute; left:1089px; top:1311px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第四章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(0</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:1038px; top:1353px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">面向可理解性的构造</span></div>
<div class="txt" style="position:absolute; left:1266px; top:1438px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">实验</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">5</span></div>
<div class="txt" style="position:absolute; left:1089px; top:1517px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第八章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(6</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:1038px; top:1559px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">面向性能的构造技术</span></div>
<div class="txt" style="position:absolute; left:1089px; top:1721px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第九章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(0</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:1128px; top:1763px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">代码重构</span></div>
<div class="txt" style="position:absolute; left:1089px; top:1923px;"><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">第十章</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">(6</span><span id="f12" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">学时</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:1054px; top:1965px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">并行</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">/</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">分布式</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">/GUI</span></div>
<div class="txt" style="position:absolute; left:1255px; top:2040px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">实验</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">6</span></div>
<img id="background" style="position:absolute; left:0px; top:2050px;" width="1440" height="1080" src="page3.png"> <img id="background" style="position:absolute; left:1440px; top:2050px;" width="1440" height="1080" src="page-000003.png">
<div class="txt" style="position:absolute; left:33px; top:2157px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Outline</span></div>
<div class="txt" style="position:absolute; left:899px; top:2068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:2297px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">What is Concurrent Programming?</span></div>
<div class="txt" style="position:absolute; left:76px; top:2369px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Processes, threads, and time-slicing</span></div>
<div class="txt" style="position:absolute; left:76px; top:2441px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Interleaving and race condition</span></div>
<div class="txt" style="position:absolute; left:76px; top:2513px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Thread safety</span></div>
<div class="txt" style="position:absolute; left:112px; top:2580px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 1: Confinement</span></div>
<div class="txt" style="position:absolute; left:112px; top:2640px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 2: Immutability</span></div>
<div class="txt" style="position:absolute; left:112px; top:2701px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 3: Using Thread-safe Data Types</span></div>
<div class="txt" style="position:absolute; left:112px; top:2761px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 4: Locks and Synchronization</span></div>
<div class="txt" style="position:absolute; left:76px; top:2827px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">How to Make a Safety Argument</span></div>
<div class="txt" style="position:absolute; left:76px; top:2899px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Summary</span></div>
<img id="background" style="position:absolute; left:0px; top:3050px;" width="1440" height="1080" src="page4.png"> <img id="background" style="position:absolute; left:1440px; top:3050px;" width="1440" height="1080" src="page-000004.png">
<div class="txt" style="position:absolute; left:1105px; top:3068px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:132px; top:3465px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">1 What is Concurrent Programming?</span></div>
<img id="background" style="position:absolute; left:0px; top:4050px;" width="1440" height="1080" src="page5.png"> <img id="background" style="position:absolute; left:1440px; top:4050px;" width="1440" height="1080" src="page-000005.png">
<div class="txt" style="position:absolute; left:33px; top:4157px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Concurrency</span></div>
<div class="txt" style="position:absolute; left:899px; top:4068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:4297px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:37px;vertical-align:baseline;color:rgba(255,0,0,1);">Concurrency </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">means multiple computations are happening at the</span></div>
<div class="txt" style="position:absolute; left:112px; top:4342px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">same time. </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">并发意味着多个运算同时发生</span></div>
<div class="txt" style="position:absolute; left:76px; top:4417px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Concurrency is everywhere in modern programming:</span></div>
<div class="txt" style="position:absolute; left:112px; top:4484px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Multiple computers in a network</span></div>
<div class="txt" style="position:absolute; left:112px; top:4544px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Multiple applications running on one computer</span></div>
<div class="txt" style="position:absolute; left:112px; top:4605px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Multiple processors in a computer (today, often multiple processor cores</span></div>
<div class="txt" style="position:absolute; left:148px; top:4648px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">on a single chip)</span></div>
<div class="txt" style="position:absolute; left:76px; top:4714px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Concurrency is essential in modern programming:</span></div>
<div class="txt" style="position:absolute; left:112px; top:4780px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Web sites must handle multiple simultaneous users.</span></div>
<div class="txt" style="position:absolute; left:112px; top:4841px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f38" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Mobile apps need to do some of their processing on servers (“in the</span></div>
<div class="txt" style="position:absolute; left:148px; top:4884px;"><span id="f38" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">cloud”).</span></div>
<div class="txt" style="position:absolute; left:112px; top:4945px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Graphical user interfaces almost always require background work that</span></div>
<div class="txt" style="position:absolute; left:148px; top:4988px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">does not interrupt the user. For example, Eclipse compiles your Java code</span></div>
<div class="txt" style="position:absolute; left:148px; top:5031px;"><span id="f38" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">while you’re still editing it.</span></div>
<img id="background" style="position:absolute; left:0px; top:5050px;" width="1440" height="1080" src="page6.png"> <img id="background" style="position:absolute; left:1440px; top:5050px;" width="1440" height="1080" src="page-000006.png">
<div class="txt" style="position:absolute; left:33px; top:5157px;"><span id="f12" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Why “Concurrency”?</span></div>
<div class="txt" style="position:absolute; left:899px; top:5068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:5294px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Processor clock speeds are no longer increasing. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">处理器时钟速度不</span></div>
<div class="txt" style="position:absolute; left:112px; top:5342px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">再增加。</span></div>
<div class="txt" style="position:absolute; left:76px; top:5417px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f24" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Instead, we’re getting more cores with each new generation of</span></div>
<div class="txt" style="position:absolute; left:112px; top:5462px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">chips. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">新一代芯片都会有更多的内核</span></div>
<div class="txt" style="position:absolute; left:76px; top:5537px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f24" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">So in the future, in order to get a computation to run faster, we’ll</span></div>
<div class="txt" style="position:absolute; left:112px; top:5582px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">have to split up a computation into concurrent pieces. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">为了让计算更</span></div>
<div class="txt" style="position:absolute; left:112px; top:5630px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">快运行，我们必须将计算分解为并发模块。</span></div>
<img id="background" style="position:absolute; left:0px; top:6050px;" width="1440" height="1080" src="page7.png"> <img id="background" style="position:absolute; left:1440px; top:6050px;" width="1440" height="1080" src="page-000007.png">
<div class="txt" style="position:absolute; left:899px; top:6068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:6157px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Two Models for Concurrent Programming</span></div>
<div class="txt" style="position:absolute; left:76px; top:6294px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">There are two common models for concurrent programming:</span></div>
<div class="txt" style="position:absolute; left:112px; top:6339px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">shared memory and message passing . </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">两种常见的并发模型：共享</span></div>
<div class="txt" style="position:absolute; left:112px; top:6387px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">内存和消息传递</span></div>
<div class="txt" style="position:absolute; left:112px; top:6456px;"><span id="f23" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Shared memory. </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">In the shared memory model of concurrency, concurrent</span></div>
<div class="txt" style="position:absolute; left:148px; top:6496px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">modules interact by reading and writing shared objects in memory. </span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">并发程</span></div>
<div class="txt" style="position:absolute; left:148px; top:6539px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">序通过读写内存中的共享对象交互</span></div>
<div class="txt" style="position:absolute; left:112px; top:6845px;"><span id="f23" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Message passing. </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">In the message-passing model, concurrent modules</span></div>
<div class="txt" style="position:absolute; left:148px; top:6889px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">interact by sending messages to each other through a communication</span></div>
<div class="txt" style="position:absolute; left:148px; top:6932px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">channel. Modules send off messages, and incoming messages to each</span></div>
<div class="txt" style="position:absolute; left:148px; top:6975px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">module are queued up for handling.</span></div>
<img id="background" style="position:absolute; left:0px; top:7050px;" width="1440" height="1080" src="page8.png"> <img id="background" style="position:absolute; left:1440px; top:7050px;" width="1440" height="1080" src="page-000008.png">
<div class="txt" style="position:absolute; left:33px; top:7157px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Shared memory</span></div>
<div class="txt" style="position:absolute; left:899px; top:7068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:7297px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Examples of the shared-memory model:</span></div>
<div class="txt" style="position:absolute; left:112px; top:7364px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B might be two processors (or processor cores) in the same</span></div>
<div class="txt" style="position:absolute; left:148px; top:7403px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">computer, sharing the same physical memory</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">. </span><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">两个处理器共享物理内存</span></div>
<div class="txt" style="position:absolute; left:112px; top:7467px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B might be two programs running on the same computer, sharing a</span></div>
<div class="txt" style="position:absolute; left:148px; top:7507px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">common file system with files they can read and write. </span><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">两个程序共享文件</span></div>
<div class="txt" style="position:absolute; left:112px; top:7571px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B might be two threads in the same Java program (we’ll explain</span></div>
<div class="txt" style="position:absolute; left:148px; top:7610px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">what a thread is below), sharing the same Java objects</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">. </span><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">两个线程共享对象</span></div>
<img id="background" style="position:absolute; left:0px; top:8050px;" width="1440" height="1080" src="page9.png"> <img id="background" style="position:absolute; left:1440px; top:8050px;" width="1440" height="1080" src="page-000009.png">
<div class="txt" style="position:absolute; left:33px; top:8157px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Message passing</span></div>
<div class="txt" style="position:absolute; left:899px; top:8068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:8297px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Examples of message passing:</span></div>
<div class="txt" style="position:absolute; left:112px; top:8364px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B might be two computers in a network, communicating by</span></div>
<div class="txt" style="position:absolute; left:148px; top:8403px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">network connections. </span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">网络中两台计算机通信</span></div>
<div class="txt" style="position:absolute; left:112px; top:8467px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B might be a web browser and a web server </span><span id="f26" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A opens a connection</span></div>
<div class="txt" style="position:absolute; left:148px; top:8511px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">to B and asks for a web page, and B sends the web page data back to A.</span></div>
<div class="txt" style="position:absolute; left:148px; top:8550px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">web</span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">浏览器和</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">web server</span></div>
<div class="txt" style="position:absolute; left:112px; top:8610px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B might be an instant messaging client and server. </span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">即时消息的客户</span></div>
<div class="txt" style="position:absolute; left:148px; top:8654px;"><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">端和服务器</span></div>
<div class="txt" style="position:absolute; left:112px; top:8718px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B might be two programs running on the same computer whose</span></div>
<div class="txt" style="position:absolute; left:148px; top:8761px;"><span id="f26" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">input and output have been connected by a pipe, like “ls | grep” typed</span></div>
<div class="txt" style="position:absolute; left:148px; top:8800px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">into a command prompt. </span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">通过管道连接两个程序的输入和输出</span></div>
<img id="background" style="position:absolute; left:0px; top:9050px;" width="1440" height="1080" src="page10.png"> <img id="background" style="position:absolute; left:1440px; top:9050px;" width="1440" height="1080" src="page-000010.png">
<div class="txt" style="position:absolute; left:1105px; top:9068px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:178px; top:9465px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">2 Processes, Threads, Time-slicing</span></div>
<img id="background" style="position:absolute; left:0px; top:10050px;" width="1440" height="1080" src="page11.png"> <img id="background" style="position:absolute; left:1440px; top:10050px;" width="1440" height="1080" src="page-000011.png">
<div class="txt" style="position:absolute; left:33px; top:10157px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Process and Threads</span></div>
<div class="txt" style="position:absolute; left:899px; top:10068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:10297px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The message-passing and shared-memory models are about how</span></div>
<div class="txt" style="position:absolute; left:112px; top:10347px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">concurrent modules communicate.</span></div>
<div class="txt" style="position:absolute; left:76px; top:10417px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The concurrent modules themselves come in two different kinds:</span></div>
<div class="txt" style="position:absolute; left:112px; top:10462px;"><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">processes and threads, </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">two basic units of execution.</span><span id="f27" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">并发模块本身主</span></div>
<div class="txt" style="position:absolute; left:112px; top:10510px;"><span id="f27" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">要分为两种类型</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">:</span><span id="f27" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">进程和线程</span></div>
<div class="txt" style="position:absolute; left:112px; top:10579px;"><span id="f35" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A process is an instance of a running program that is </span><span id="f38" style="font-size:33px;vertical-align:baseline;color:rgba(0,0,255,1);">isolated </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">from other</span></div>
<div class="txt" style="position:absolute; left:148px; top:10623px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">processes on the same machine. In particular, it has its own private section</span></div>
<div class="txt" style="position:absolute; left:148px; top:10662px;"><span id="f42" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">of the machine’s memory. </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">进程是正在运行程序的一个实例，拥有自己私有</span></div>
<div class="txt" style="position:absolute; left:148px; top:10706px;"><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">专用的内存空间</span></div>
<div class="txt" style="position:absolute; left:112px; top:10770px;"><span id="f35" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A thread is a locus of control inside a running program. Think of it as a</span></div>
<div class="txt" style="position:absolute; left:148px; top:10813px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">place in the program that is being run, plus the stack of method calls that</span></div>
<div class="txt" style="position:absolute; left:148px; top:10856px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">led to that place (so the thread can go back up the stack when it reaches</span></div>
<div class="txt" style="position:absolute; left:148px; top:10895px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">return statements). </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">线程是正在运行程序的一个执行路径（一个进程可对应</span></div>
<div class="txt" style="position:absolute; left:148px; top:10939px;"><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">多个线程），线程有自己的堆栈和局部变量，但是多个线程共享内存空间</span></div>
<img id="background" style="position:absolute; left:0px; top:11050px;" width="1440" height="1080" src="page12.png"> <img id="background" style="position:absolute; left:1440px; top:11050px;" width="1440" height="1080" src="page-000012.png">
<div class="txt" style="position:absolute; left:1105px; top:11068px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:549px; top:11465px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">(1) Process</span></div>
<img id="background" style="position:absolute; left:0px; top:12050px;" width="1440" height="1080" src="page13.png"> <img id="background" style="position:absolute; left:1440px; top:12050px;" width="1440" height="1080" src="page-000013.png">
<div class="txt" style="position:absolute; left:33px; top:12157px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Process</span></div>
<div class="txt" style="position:absolute; left:899px; top:12068px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:56px; top:12285px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The process abstraction is a virtual computer </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">(a self-contained</span></div>
<div class="txt" style="position:absolute; left:92px; top:12335px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">execution environment with a complete, private set of basic run-time</span></div>
<div class="txt" style="position:absolute; left:92px; top:12379px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">resources, in particular, memory space). </span><span id="f25" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">进程可抽象为虚拟计算机，</span></div>
<div class="txt" style="position:absolute; left:92px; top:12427px;"><span id="f25" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">拥有独立的执行环境和完整的资源</span></div>
<div class="txt" style="position:absolute; left:92px; top:12496px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">It makes the program feel like it has the entire machine to itself </span><span id="f32" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">like a</span></div>
<div class="txt" style="position:absolute; left:128px; top:12540px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">fresh computer has been created, with fresh memory, just to run that</span></div>
<div class="txt" style="position:absolute; left:128px; top:12583px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">program.</span></div>
<div class="txt" style="position:absolute; left:56px; top:12648px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Just like computers connected across a network, processes</span></div>
<div class="txt" style="position:absolute; left:92px; top:12694px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">normally share no memory between them. </span><span id="f25" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">进程间通常不共享内存</span></div>
<div class="txt" style="position:absolute; left:92px; top:12759px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f32" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A process can’t access another process’s memory or objects at all. </span><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">进程不能</span></div>
<div class="txt" style="position:absolute; left:128px; top:12803px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">访问其他进程的内存或对象</span></div>
<div class="txt" style="position:absolute; left:92px; top:12867px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Sharing memory between processes is possible on most operating systems,</span></div>
<div class="txt" style="position:absolute; left:128px; top:12906px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">but it needs special effort. </span><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">需要特殊机制才能实现进程间共享内存</span></div>
<div class="txt" style="position:absolute; left:92px; top:12971px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">By contrast, </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">a new process is automatically ready for message passing,</span></div>
<div class="txt" style="position:absolute; left:128px; top:13014px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">because it is created with standard input &amp; output streams</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, which are the</span></div>
<div class="txt" style="position:absolute; left:128px; top:13057px;"><span id="f58" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">System.out </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">and </span><span id="f58" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">System.in </span><span id="f32" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">streams you’ve used in Java. </span><span id="f25" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,255,1);">进程通信采用的是消</span></div>
<div class="txt" style="position:absolute; left:128px; top:15340px;"><span id="f25" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,255,1);">息传递方式（因采用标准</span><span id="f15" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,255,1);">I/O </span><span id="f25" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,255,1);">流）</span></div>
<img id="background" style="position:absolute; left:0px; top:15481px;" width="1440" height="1080" src="page14.png"> <img id="background" style="position:absolute; left:1440px; top:15481px;" width="1440" height="1080" src="page-000014.png">
<div class="txt" style="position:absolute; left:33px; top:15588px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Process</span></div>
<div class="txt" style="position:absolute; left:899px; top:15499px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:15728px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Processes are often seen as synonymous with programs or</span></div>
<div class="txt" style="position:absolute; left:112px; top:15778px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">applications.</span></div>
<div class="txt" style="position:absolute; left:76px; top:15848px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">However, what the user sees as a single application may in fact be</span></div>
<div class="txt" style="position:absolute; left:112px; top:15893px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">a set of cooperating processes. </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">应用程序实际上可能是一组协作进程</span></div>
<div class="txt" style="position:absolute; left:76px; top:15968px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">To facilitate communication between processes, most operating</span></div>
<div class="txt" style="position:absolute; left:112px; top:16018px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">systems support Inter Process Communication (IPC) resources,</span></div>
<div class="txt" style="position:absolute; left:112px; top:16061px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">such as pipes and sockets. </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">为了实现进程间通信，大多数操作系统都</span></div>
<div class="txt" style="position:absolute; left:112px; top:16109px;"><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">支持</span><span id="f41" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">”</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">进程间通信（</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">IPC</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">）资源</span><span id="f41" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">”</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">，例如</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">pipe</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">和</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">socket</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">。</span></div>
<div class="txt" style="position:absolute; left:112px; top:16179px;"><span id="f61" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">IPC is used not just for communication between processes on the same</span></div>
<div class="txt" style="position:absolute; left:148px; top:16222px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">system, but processes on different systems.</span></div>
<div class="txt" style="position:absolute; left:76px; top:16288px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Most implementations of the Java virtual machine run as a single</span></div>
<div class="txt" style="position:absolute; left:112px; top:16333px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">process. </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Java</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">虚拟机本身的大多数实现都是作为单个进程运行的</span></div>
<div class="txt" style="position:absolute; left:76px; top:16408px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">A Java application can create additional processes using</span></div>
<div class="txt" style="position:absolute; left:112px; top:16457px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">a ProcessBuilder object.</span></div>
<img id="background" style="position:absolute; left:0px; top:16668px;" width="1440" height="1080" src="page15.png"> <img id="background" style="position:absolute; left:1440px; top:16668px;" width="1440" height="1080" src="page-000015.png">
<div class="txt" style="position:absolute; left:1105px; top:16686px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:554px; top:17083px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">(2) Thread</span></div>
<img id="background" style="position:absolute; left:0px; top:17855px;" width="1440" height="1080" src="page16.png"> <img id="background" style="position:absolute; left:1440px; top:17855px;" width="1440" height="1080" src="page-000016.png">
<div class="txt" style="position:absolute; left:899px; top:17873px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:17962px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Thread and Multi-threaded programming</span></div>
<div class="txt" style="position:absolute; left:76px; top:18102px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Just as a process represents a virtual computer, the thread abstraction</span></div>
<div class="txt" style="position:absolute; left:112px; top:18151px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">represents a </span><span id="f20" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,0,1);">virtual processor</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">, and threads are sometimes</span></div>
<div class="txt" style="position:absolute; left:112px; top:18195px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">called </span><span id="f24" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,0,1);">lightweight process </span><span id="f27" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">线程可抽象为一个虚拟处理器，线程有时也称为</span></div>
<div class="txt" style="position:absolute; left:112px; top:18243px;"><span id="f27" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">轻量级进程</span></div>
<div class="txt" style="position:absolute; left:112px; top:18313px;"><span id="f39" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Making a new thread simulates making a fresh processor inside the virtual</span></div>
<div class="txt" style="position:absolute; left:148px; top:18356px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">computer represented by the process.</span></div>
<div class="txt" style="position:absolute; left:112px; top:18416px;"><span id="f39" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">This new virtual processor runs the same program and shares the same</span></div>
<div class="txt" style="position:absolute; left:148px; top:18460px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">resources (memory, open files, etc) as other threads in the process, i.e.,</span></div>
<div class="txt" style="position:absolute; left:148px; top:18499px;"><span id="f48" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">“</span><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">threads exist within a process</span><span id="f48" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">”. </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">线程与进程中的其他线程共享相同的资源（</span></div>
<div class="txt" style="position:absolute; left:148px; top:18542px;"><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">内存，打开的文件等），即“线程存在于进程内”</span></div>
<div class="txt" style="position:absolute; left:76px; top:18612px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">Threads are automatically ready for shared memory, because threads</span></div>
<div class="txt" style="position:absolute; left:112px; top:18657px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">share all the memory in the process. </span><span id="f27" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">进程内的线程共享内存</span></div>
<div class="txt" style="position:absolute; left:112px; top:18727px;"><span id="f39" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f48" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">It takes special effort to get “thread</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">-</span><span id="f48" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">local” memory that’s private to a single</span></div>
<div class="txt" style="position:absolute; left:148px; top:18770px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">thread.</span></div>
<div class="txt" style="position:absolute; left:112px; top:18830px;"><span id="f39" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f48" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">It’s also necessary to set up message</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">-passing explicitly, by creating and using</span></div>
<div class="txt" style="position:absolute; left:148px; top:18873px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">queue data structures. </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">线程需要特殊处理才能实现消息传递和访问私有内存</span></div>
<img id="background" style="position:absolute; left:0px; top:19042px;" width="1440" height="1080" src="page17.png"> <img id="background" style="position:absolute; left:1440px; top:19042px;" width="1440" height="1080" src="page-000017.png">
<div class="txt" style="position:absolute; left:33px; top:19149px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Threads vs. processes</span></div>
<div class="txt" style="position:absolute; left:899px; top:19060px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:19289px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Threads are </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">lightweight</span></div>
<div class="txt" style="position:absolute; left:796px; top:19291px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Processes </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">heavyweight</span></div>
<div class="txt" style="position:absolute; left:76px; top:19361px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Threads </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">share </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">address space</span></div>
<div class="txt" style="position:absolute; left:796px; top:19363px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Processes have </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">own</span></div>
<div class="txt" style="position:absolute; left:76px; top:19433px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Threads require </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">synchronization</span></div>
<div class="txt" style="position:absolute; left:796px; top:19435px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Processes </span><span id="f29" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">don’t</span></div>
<div class="txt" style="position:absolute; left:112px; top:19500px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Threads hold locks while mutating objects</span></div>
<div class="txt" style="position:absolute; left:76px; top:19565px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f29" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">It’s </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">unsafe </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">to kill threads</span></div>
<div class="txt" style="position:absolute; left:796px; top:19567px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Safe </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">to kill processes</span></div>
<img id="background" style="position:absolute; left:0px; top:20229px;" width="1440" height="1080" src="page18.png"> <img id="background" style="position:absolute; left:1440px; top:20229px;" width="1440" height="1080" src="page-000018.png">
<div class="txt" style="position:absolute; left:33px; top:20336px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Why use threads?</span></div>
<div class="txt" style="position:absolute; left:899px; top:20247px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:20473px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Performance in the face of blocking activities </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">解决阻塞活动时的性能</span></div>
<div class="txt" style="position:absolute; left:112px; top:20543px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Consider a web server</span></div>
<div class="txt" style="position:absolute; left:76px; top:20608px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Performance on multiprocessors</span></div>
<div class="txt" style="position:absolute; left:76px; top:20680px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Cleanly dealing with natural concurrency</span></div>
<div class="txt" style="position:absolute; left:76px; top:20752px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">In Java threads are a fact of life</span></div>
<div class="txt" style="position:absolute; left:112px; top:20819px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Example: garbage collector runs in its own thread</span></div>
<div class="txt" style="position:absolute; left:371px; top:20977px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Number of Threads</span></div>
<div class="txt" style="position:absolute; left:515px; top:21025px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">1</span></div>
<div class="txt" style="position:absolute; left:515px; top:21073px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">2</span></div>
<div class="txt" style="position:absolute; left:515px; top:21121px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">3</span></div>
<div class="txt" style="position:absolute; left:515px; top:21169px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">4</span></div>
<div class="txt" style="position:absolute; left:803px; top:20977px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Seconds to run</span></div>
<div class="txt" style="position:absolute; left:803px; top:21025px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">22.0</span></div>
<div class="txt" style="position:absolute; left:803px; top:21073px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">13.5</span></div>
<div class="txt" style="position:absolute; left:803px; top:21121px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">11.7</span></div>
<div class="txt" style="position:absolute; left:803px; top:21169px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">10.8</span></div>
<img id="background" style="position:absolute; left:0px; top:21416px;" width="1440" height="1080" src="page19.png"> <img id="background" style="position:absolute; left:1440px; top:21416px;" width="1440" height="1080" src="page-000019.png">
<div class="txt" style="position:absolute; left:899px; top:21434px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:21523px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">We are all concurrent programmers </span><span id="f13" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">…</span></div>
<div class="txt" style="position:absolute; left:76px; top:21663px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">In order to utilize our multicore processors, we must write</span></div>
<div class="txt" style="position:absolute; left:112px; top:21708px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">multithreaded code </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">为了利用多核处理器，必须编写多线程代码</span></div>
<div class="txt" style="position:absolute; left:76px; top:21828px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Good news: a lot of it is written for you </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Java</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">提供了并发编程的库函数</span></div>
<div class="txt" style="position:absolute; left:112px; top:21897px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Excellent libraries exist (</span><span id="f32" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">java.util.concurrent</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">)</span></div>
<div class="txt" style="position:absolute; left:76px; top:21961px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Bad news: you still must understand fundamentals </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">需要理解基本概念</span></div>
<div class="txt" style="position:absolute; left:112px; top:22030px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">to use libraries effectively</span></div>
<div class="txt" style="position:absolute; left:112px; top:22091px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">to debug programs that make use of them</span></div>
<img id="background" style="position:absolute; left:0px; top:22603px;" width="1440" height="1080" src="page20.png"> <img id="background" style="position:absolute; left:1440px; top:22603px;" width="1440" height="1080" src="page-000020.png">
<div class="txt" style="position:absolute; left:33px; top:22710px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Thread States</span></div>
<div class="txt" style="position:absolute; left:899px; top:22621px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<img id="background" style="position:absolute; left:0px; top:23790px;" width="1440" height="1080" src="page21.png"> <img id="background" style="position:absolute; left:1440px; top:23790px;" width="1440" height="1080" src="page-000021.png">
<div class="txt" style="position:absolute; left:33px; top:23897px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Thread</span></div>
<div class="txt" style="position:absolute; left:899px; top:23808px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:24037px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Multithreaded execution </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">is an essential feature of the Java platform.</span></div>
<div class="txt" style="position:absolute; left:76px; top:24106px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Every application has at least one thread. </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">每个应用程序至少有一个</span></div>
<div class="txt" style="position:absolute; left:112px; top:24154px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">线程</span></div>
<div class="txt" style="position:absolute; left:76px; top:24229px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">From the application programmer‘s point of view, you start with just</span></div>
<div class="txt" style="position:absolute; left:112px; top:24278px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">one thread, called the </span><span id="f29" style="font-size:37px;vertical-align:baseline;color:rgba(192,0,0,1);">main thread</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">. This thread has the ability to</span></div>
<div class="txt" style="position:absolute; left:112px; top:24322px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(192,0,0,1);">create additional threads. </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">站在程序员角度，</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">main</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">线程是开始线程，</span></div>
<div class="txt" style="position:absolute; left:112px; top:24370px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">可以通过它创建其他的线程</span></div>
<div class="txt" style="position:absolute; left:76px; top:24517px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Two ways to create a thread:</span></div>
<div class="txt" style="position:absolute; left:112px; top:24580px;"><span id="f43" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">(Seldom used) </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Subclassing </span><span id="f47" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">. </span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">创建</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">Thread</span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">类的子类</span></div>
<div class="txt" style="position:absolute; left:112px; top:24644px;"><span id="f43" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">(More generally used) </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Implement the </span><span id="f47" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Runnable </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">interface and use the </span><span id="f47" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">new</span></div>
<div class="txt" style="position:absolute; left:148px; top:24683px;"><span id="f47" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread(..) </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">constructor. </span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">实现</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">Runnable</span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">接口，作为参数传递给 </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">new</span></div>
<div class="txt" style="position:absolute; left:148px; top:24727px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">Thread(..)</span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">构造函数</span></div>
<img id="background" style="position:absolute; left:0px; top:24977px;" width="1440" height="1080" src="page22.png"> <img id="background" style="position:absolute; left:1440px; top:24977px;" width="1440" height="1080" src="page-000022.png">
<div class="txt" style="position:absolute; left:33px; top:25084px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Ways to create a thread</span></div>
<div class="txt" style="position:absolute; left:899px; top:24995px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:25224px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">All threads should implement the Runnable interface and</span></div>
<div class="txt" style="position:absolute; left:112px; top:25269px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">implement the run() method. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">所有的线程都需要实现</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Runnable</span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">接</span></div>
<div class="txt" style="position:absolute; left:112px; top:25317px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">口，并实现</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">run()</span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">方法</span></div>
<div class="txt" style="position:absolute; left:76px; top:25385px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">Runnable </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">interface represents the work to be done by a</span></div>
<div class="txt" style="position:absolute; left:112px; top:25434px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">thread.</span></div>
<div class="txt" style="position:absolute; left:289px; top:25533px;"><span id="f36" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public interface Runnable {</span></div>
<div class="txt" style="position:absolute; left:348px; top:25576px;"><span id="f36" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">void run();</span></div>
<div class="txt" style="position:absolute; left:289px; top:25619px;"><span id="f36" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<img id="background" style="position:absolute; left:0px; top:26164px;" width="1440" height="1080" src="page23.png"> <img id="background" style="position:absolute; left:1440px; top:26164px;" width="1440" height="1080" src="page-000023.png">
<div class="txt" style="position:absolute; left:33px; top:26271px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Ways to create a thread</span></div>
<div class="txt" style="position:absolute; left:899px; top:26182px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:26408px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Method1</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">：</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Subclass </span><span id="f20" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread</span></div>
<div class="txt" style="position:absolute; left:112px; top:26477px;"><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The </span><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">class itself implements </span><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Runnable</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, though its run method</span></div>
<div class="txt" style="position:absolute; left:148px; top:26521px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">does nothing. An application can subclass </span><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, providing its own</span></div>
<div class="txt" style="position:absolute; left:148px; top:26564px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">implementation of </span><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">run()</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">.</span></div>
<div class="txt" style="position:absolute; left:76px; top:26630px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">To invoke </span><span id="f20" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread.start() </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">in order to start the new thread.</span></div>
<div class="txt" style="position:absolute; left:167px; top:26744px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public class HelloThread extends Thread {</span></div>
<div class="txt" style="position:absolute; left:246px; top:26787px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public void run() {</span></div>
<div class="txt" style="position:absolute; left:325px; top:26831px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">System.out.println("Hello from a thread!");</span></div>
<div class="txt" style="position:absolute; left:246px; top:26874px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<div class="txt" style="position:absolute; left:246px; top:26917px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public static void main(String args[]) {</span></div>
<div class="txt" style="position:absolute; left:325px; top:26960px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">(new HelloThread()).start();</span></div>
<div class="txt" style="position:absolute; left:325px; top:27003px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">(new HelloThread()).start();</span></div>
<div class="txt" style="position:absolute; left:325px; top:27047px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">(new HelloThread()).start();</span></div>
<div class="txt" style="position:absolute; left:246px; top:27090px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<div class="txt" style="position:absolute; left:167px; top:27133px;"><span id="f20" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<img id="background" style="position:absolute; left:0px; top:27351px;" width="1440" height="1080" src="page24.png"> <img id="background" style="position:absolute; left:1440px; top:27351px;" width="1440" height="1080" src="page-000024.png">
<div class="txt" style="position:absolute; left:33px; top:27458px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Ways to create a thread</span></div>
<div class="txt" style="position:absolute; left:899px; top:27369px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:27598px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Method 2: Provide a </span><span id="f17" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">Runnable </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">object</span></div>
<div class="txt" style="position:absolute; left:112px; top:27664px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The </span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Runnable </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">interface defines a single method, </span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">run()</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, meant to</span></div>
<div class="txt" style="position:absolute; left:148px; top:27708px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">contain the code executed in the thread. The </span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Runnable </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">object is passed</span></div>
<div class="txt" style="position:absolute; left:148px; top:27751px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">to the </span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">constructor.</span></div>
<div class="txt" style="position:absolute; left:76px; top:27817px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">To invoke </span><span id="f17" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">Thread.start() </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">in order to start the new thread.</span></div>
<div class="txt" style="position:absolute; left:167px; top:27896px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public class HelloRunnable implements Runnable {</span></div>
<div class="txt" style="position:absolute; left:246px; top:27939px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">@Override</span></div>
<div class="txt" style="position:absolute; left:246px; top:27982px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public void run() {</span></div>
<div class="txt" style="position:absolute; left:325px; top:28026px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">System.out.println("Hello from a thread!");</span></div>
<div class="txt" style="position:absolute; left:246px; top:28069px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<div class="txt" style="position:absolute; left:246px; top:28112px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public static void main(String args[]) {</span></div>
<div class="txt" style="position:absolute; left:325px; top:28155px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">(new Thread(new HelloRunnable())).start();</span></div>
<div class="txt" style="position:absolute; left:246px; top:28199px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<div class="txt" style="position:absolute; left:167px; top:28242px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<img id="background" style="position:absolute; left:0px; top:28538px;" width="1440" height="1080" src="page25.png"> <img id="background" style="position:absolute; left:1440px; top:28538px;" width="1440" height="1080" src="page-000025.png">
<div class="txt" style="position:absolute; left:33px; top:28645px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Ways to create a thread</span></div>
<div class="txt" style="position:absolute; left:899px; top:28556px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:28785px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">A very common idiom is starting a thread with an </span><span id="f17" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">anonymous</span></div>
<div class="txt" style="position:absolute; left:112px; top:28830px;"><span id="f17" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">Runnable</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">, which eliminates the named class. </span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">惯用法：用一个匿名</span></div>
<div class="txt" style="position:absolute; left:112px; top:28878px;"><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">的</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Runnable</span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">启动一个线程，它避免了创建命名的类</span></div>
<div class="txt" style="position:absolute; left:224px; top:28976px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">new Thread(new Runnable() {</span></div>
<div class="txt" style="position:absolute; left:283px; top:29020px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">@Override</span></div>
<div class="txt" style="position:absolute; left:283px; top:29063px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">public void run() {</span></div>
<div class="txt" style="position:absolute; left:362px; top:29106px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">System.out.println("Hello from a thread!");</span></div>
<div class="txt" style="position:absolute; left:283px; top:29149px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<div class="txt" style="position:absolute; left:224px; top:29192px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">}).start();</span></div>
<div class="txt" style="position:absolute; left:76px; top:29313px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Create a thread with lambda expression (after JDK 8+)</span></div>
<div class="txt" style="position:absolute; left:34px; top:29376px;"><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">new Thread(() -&gt; System.out.println("Hello from a thread!")).start();</span></div>
<img id="background" style="position:absolute; left:0px; top:29725px;" width="1440" height="1080" src="page26.png"> <img id="background" style="position:absolute; left:1440px; top:29725px;" width="1440" height="1080" src="page-000026.png">
<div class="txt" style="position:absolute; left:33px; top:29832px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Anonymous classes</span></div>
<div class="txt" style="position:absolute; left:899px; top:29743px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:65px; top:29972px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Usually when we implement an interface, we do so by declaring a</span></div>
<div class="txt" style="position:absolute; left:101px; top:30021px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">class. For example, given the interface </span><span id="f19" style="font-size:37px;vertical-align:baseline;color:rgba(255,0,0,1);">Comparator </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">in the Java API:</span></div>
<div class="txt" style="position:absolute; left:65px; top:30380px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">We might declare:</span></div>
<img id="background" style="position:absolute; left:0px; top:30912px;" width="1440" height="1080" src="page27.png"> <img id="background" style="position:absolute; left:1440px; top:30912px;" width="1440" height="1080" src="page-000027.png">
<div class="txt" style="position:absolute; left:33px; top:31019px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Anonymous classes</span></div>
<div class="txt" style="position:absolute; left:899px; top:30930px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:54px; top:31155px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">One purpose of </span><span id="f17" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,0,1);">Comparator </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">is for sorting.</span></div>
<div class="txt" style="position:absolute; left:54px; top:31227px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">A SortedSet keeps its items in a total order. Without a Comparator,</span></div>
<div class="txt" style="position:absolute; left:90px; top:31277px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">the SortedSet implementation uses the compareTo method</span></div>
<div class="txt" style="position:absolute; left:90px; top:31320px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">provided by the objects in the set. </span><span id="f31" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">对于可排序集合，如果没有指定</span></div>
<div class="txt" style="position:absolute; left:90px; top:31368px;"><span id="f31" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">比较器，会采用所保存对象实现的</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">compareTo</span><span id="f31" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">方法</span></div>
<img id="background" style="position:absolute; left:0px; top:32099px;" width="1440" height="1080" src="page28.png"> <img id="background" style="position:absolute; left:1440px; top:32099px;" width="1440" height="1080" src="page-000028.png">
<div class="txt" style="position:absolute; left:33px; top:32206px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Anonymous classes</span></div>
<div class="txt" style="position:absolute; left:54px; top:32342px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">With a Comparator:</span></div>
<div class="txt" style="position:absolute; left:899px; top:32117px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:54px; top:32774px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">If we only intend to use this comparator in this one place, we</span></div>
<div class="txt" style="position:absolute; left:90px; top:32824px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">already know how to eliminate the variable:</span></div>
<img id="background" style="position:absolute; left:0px; top:33286px;" width="1440" height="1080" src="page29.png"> <img id="background" style="position:absolute; left:1440px; top:33286px;" width="1440" height="1080" src="page-000029.png">
<div class="txt" style="position:absolute; left:33px; top:33393px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Anonymous classes</span></div>
<div class="txt" style="position:absolute; left:899px; top:33304px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:54px; top:33529px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">An </span><span id="f17" style="font-size:37px;vertical-align:baseline;color:rgba(192,0,0,1);">anonymous class </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">declares an unnamed class that implements an</span></div>
<div class="txt" style="position:absolute; left:90px; top:33579px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">interface and immediately creates the one and only instance of that</span></div>
<div class="txt" style="position:absolute; left:90px; top:33627px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">class. Compare to the code above:</span></div>
<img id="background" style="position:absolute; left:0px; top:34473px;" width="1440" height="1080" src="page30.png"> <img id="background" style="position:absolute; left:1440px; top:34473px;" width="1440" height="1080" src="page-000030.png">
<div class="txt" style="position:absolute; left:33px; top:34580px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Anonymous classes</span></div>
<div class="txt" style="position:absolute; left:899px; top:34491px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:54px; top:34716px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Advantages of anonymous class over named class:</span></div>
<div class="txt" style="position:absolute; left:90px; top:34783px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">If we’re only using the comparator in this one piece of code, we’ve reduced its</span></div>
<div class="txt" style="position:absolute; left:126px; top:34826px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">scope by using an anonymous class. With a named class, any other code could</span></div>
<div class="txt" style="position:absolute; left:126px; top:34865px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">start using and depending on StringLengthComparator. </span><span id="f26" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">明确了使用范围</span></div>
<div class="txt" style="position:absolute; left:90px; top:34930px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A reader no longer has to search elsewhere for the details of the comparator,</span></div>
<div class="txt" style="position:absolute; left:126px; top:34969px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">everything is right here. </span><span id="f26" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">读者不需要寻找定义</span></div>
<div class="txt" style="position:absolute; left:54px; top:35039px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Disadvantages:</span></div>
<div class="txt" style="position:absolute; left:90px; top:35105px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">If we need the same comparator more than once, we might be tempted to</span></div>
<div class="txt" style="position:absolute; left:126px; top:35145px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">copy-and-paste the anonymous class. The named class is DRY. </span><span id="f26" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">不能复用</span></div>
<div class="txt" style="position:absolute; left:90px; top:35209px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">If the implementation of the anonymous class is long, it interrupts the</span></div>
<div class="txt" style="position:absolute; left:126px; top:35252px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">surrounding code, making it harder to understand. The named class is</span></div>
<div class="txt" style="position:absolute; left:126px; top:35292px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">separated out as a modular piece. </span><span id="f26" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">代码过长时，影响理解</span></div>
<div class="txt" style="position:absolute; left:54px; top:35361px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">So anonymous classes are good for short one-off implementations of a</span></div>
<div class="txt" style="position:absolute; left:90px; top:35407px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">method. </span><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">匿名类对于短的一次性的方法实现</span></div>
<img id="background" style="position:absolute; left:0px; top:35660px;" width="1440" height="1080" src="page31.png"> <img id="background" style="position:absolute; left:1440px; top:35660px;" width="1440" height="1080" src="page-000031.png">
<div class="txt" style="position:absolute; left:1105px; top:35678px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:174px; top:36075px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">3 Interleaving and Race Condition</span></div>
<img id="background" style="position:absolute; left:0px; top:36847px;" width="1440" height="1080" src="page32.png"> <img id="background" style="position:absolute; left:1440px; top:36847px;" width="1440" height="1080" src="page-000032.png">
<div class="txt" style="position:absolute; left:33px; top:36954px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Time slicing</span></div>
<div class="txt" style="position:absolute; left:899px; top:36865px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:37094px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">In computer systems that have a single execution core, only one</span></div>
<div class="txt" style="position:absolute; left:112px; top:37139px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">thread is actually executing at any given moment. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">在某时刻，一个</span></div>
<div class="txt" style="position:absolute; left:112px; top:37187px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">运行核心上只有一个线程可以运行</span></div>
<div class="txt" style="position:absolute; left:112px; top:37257px;"><span id="f23" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Processing time for a single core is shared among processes and threads</span></div>
<div class="txt" style="position:absolute; left:148px; top:37296px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">through an OS feature called </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">time slicing</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">. </span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">进程</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">/</span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">线程等采用</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">OS</span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">提供的时间</span></div>
<div class="txt" style="position:absolute; left:148px; top:37339px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">片机制共享处理时间</span></div>
<div class="txt" style="position:absolute; left:76px; top:37469px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f42" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Today’s computer systems to have multiple processors or processors</span></div>
<div class="txt" style="position:absolute; left:112px; top:37519px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">with multiple execution cores. </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">So, how can I have many concurrent</span></div>
<div class="txt" style="position:absolute; left:112px; top:37567px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">threads with only one or two processors in my computer?</span></div>
<div class="txt" style="position:absolute; left:112px; top:37632px;"><span id="f23" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">When there are more threads than processors, concurrency is simulated</span></div>
<div class="txt" style="position:absolute; left:148px; top:37675px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">by </span><span id="f50" style="font-size:33px;vertical-align:baseline;color:rgba(255,0,0,1);">time slicing</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, which means that the processor switches between threads.</span></div>
<div class="txt" style="position:absolute; left:112px; top:37735px;"><span id="f23" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">当线程数多于处理器数量时，并发通过时间片来模拟，处理器切换处理不</span></div>
<div class="txt" style="position:absolute; left:148px; top:37775px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">同的线程。</span></div>
<img id="background" style="position:absolute; left:0px; top:38034px;" width="1440" height="1080" src="page33.png"> <img id="background" style="position:absolute; left:1440px; top:38034px;" width="1440" height="1080" src="page-000033.png">
<div class="txt" style="position:absolute; left:33px; top:38141px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">An example of time slicing</span></div>
<div class="txt" style="position:absolute; left:899px; top:38052px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:38281px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Three threads T1, T2, and T3 might be time-sliced on a machine</span></div>
<div class="txt" style="position:absolute; left:112px; top:38331px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">that has two actual processors.</span></div>
<div class="txt" style="position:absolute; left:112px; top:38396px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">At first one processor is running thread T1 and the other is running thread</span></div>
<div class="txt" style="position:absolute; left:148px; top:38439px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">T2, and then the second processor switches to run thread T3.</span></div>
<div class="txt" style="position:absolute; left:112px; top:38499px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Thread T2 simply pauses, until its next time slice on the same processor or</span></div>
<div class="txt" style="position:absolute; left:148px; top:38543px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">another processor.</span></div>
<div class="txt" style="position:absolute; left:76px; top:38911px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">On most systems, time slicing happens unpredictably and</span></div>
<div class="txt" style="position:absolute; left:112px; top:38960px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">nondeterministically, meaning that a thread may be paused or</span></div>
<div class="txt" style="position:absolute; left:112px; top:39004px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">resumed at any time. </span><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">时间片的使用是不可预知和非确定性的，这意</span></div>
<div class="txt" style="position:absolute; left:112px; top:39052px;"><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">味着线程可能随时暂停或恢复。</span></div>
<img id="background" style="position:absolute; left:0px; top:39221px;" width="1440" height="1080" src="page34.png"> <img id="background" style="position:absolute; left:1440px; top:39221px;" width="1440" height="1080" src="page-000034.png">
<div class="txt" style="position:absolute; left:33px; top:39328px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Shared Memory Example</span></div>
<div class="txt" style="position:absolute; left:899px; top:39239px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:39465px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Shared memory could induce subtle bugs !!! </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">共享内存可能会导致微</span></div>
<div class="txt" style="position:absolute; left:112px; top:39513px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">妙的错误</span></div>
<div class="txt" style="position:absolute; left:76px; top:39588px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Example: </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">a bank has cash machines that use a shared memory</span></div>
<div class="txt" style="position:absolute; left:112px; top:39638px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">model, so all the cash machines can read and write the same account</span></div>
<div class="txt" style="position:absolute; left:112px; top:39686px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">objects in memory.</span></div>
<img id="background" style="position:absolute; left:0px; top:40408px;" width="1440" height="1080" src="page35.png"> <img id="background" style="position:absolute; left:1440px; top:40408px;" width="1440" height="1080" src="page-000035.png">
<div class="txt" style="position:absolute; left:33px; top:40515px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Shared Memory Example</span></div>
<div class="txt" style="position:absolute; left:899px; top:40426px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:40655px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">To illustrate what can go wrong, let’s simplify the bank down to a</span></div>
<div class="txt" style="position:absolute; left:112px; top:40705px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">single account, with a dollar balance stored in the balance variable,</span></div>
<div class="txt" style="position:absolute; left:112px; top:40753px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">and two operations deposit and withdraw that simply add or</span></div>
<div class="txt" style="position:absolute; left:112px; top:40796px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">remove a dollar: </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">假定每次存</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">/</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">取款都处理</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">1</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">美元</span></div>
<div class="txt" style="position:absolute; left:76px; top:41231px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Customers use the cash machines to do transactions like this:</span></div>
<img id="background" style="position:absolute; left:0px; top:41595px;" width="1440" height="1080" src="page36.png"> <img id="background" style="position:absolute; left:1440px; top:41595px;" width="1440" height="1080" src="page-000036.png">
<div class="txt" style="position:absolute; left:33px; top:41702px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Shared Memory Example</span></div>
<div class="txt" style="position:absolute; left:899px; top:41613px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:41842px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Every transaction is just a one dollar deposit followed by a one-</span></div>
<div class="txt" style="position:absolute; left:112px; top:41892px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">dollar withdrawal, so it should leave the balance in the account</span></div>
<div class="txt" style="position:absolute; left:112px; top:41940px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">unchanged.</span></div>
<div class="txt" style="position:absolute; left:112px; top:42005px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Throughout the day, each cash</span></div>
<div class="txt" style="position:absolute; left:148px; top:42048px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">machine in our network is</span></div>
<div class="txt" style="position:absolute; left:148px; top:42091px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">processing a sequence of</span></div>
<div class="txt" style="position:absolute; left:148px; top:42134px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">deposit/withdraw transactions.</span></div>
<div class="txt" style="position:absolute; left:112px; top:42191px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">每次交易都是存入</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">1</span><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">元，取出</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">1</span><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">元</span></div>
<div class="txt" style="position:absolute; left:76px; top:42260px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">At the end of the day, regardless of how many cash machines were</span></div>
<div class="txt" style="position:absolute; left:112px; top:42310px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">running, or how many transactions we processed, we should expect</span></div>
<div class="txt" style="position:absolute; left:112px; top:42354px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">the account balance to still be </span><span id="f43" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">0</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">. </span><span id="f29" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">全天交易后，账户余额应为</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">0.</span></div>
<div class="txt" style="position:absolute; left:112px; top:42423px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">But if we run this code, we discover frequently that the balance at the end</span></div>
<div class="txt" style="position:absolute; left:148px; top:42466px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">of the day is not </span><span id="f43" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">0</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">. If more than one </span><span id="f43" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">cashMachine() </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">call is running at the</span></div>
<div class="txt" style="position:absolute; left:148px; top:42510px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">same time </span><span id="f59" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">say, on separate processors in the same computer </span><span id="f59" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">then</span></div>
<div class="txt" style="position:absolute; left:148px; top:42550px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">balance may not be zero at the end of the day. Why not? </span><span id="f29" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">当有多个</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">ATM</span></div>
<div class="txt" style="position:absolute; left:148px; top:42598px;"><span id="f29" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">时，余额却有可能不为</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">0</span><span id="f29" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">？？</span></div>
<img id="background" style="position:absolute; left:0px; top:42782px;" width="1440" height="1080" src="page37.png"> <img id="background" style="position:absolute; left:1440px; top:42782px;" width="1440" height="1080" src="page-000037.png">
<div class="txt" style="position:absolute; left:33px; top:42884px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Interleaving </span><span id="f13" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">交叉</span><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">/</span><span id="f13" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">交错</span></div>
<div class="txt" style="position:absolute; left:899px; top:42800px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:65px; top:43017px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Suppose two cash machines, A and B, are both</span></div>
<div class="txt" style="position:absolute; left:101px; top:43067px;"><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">working on a deposit at the same time. Here’s</span></div>
<div class="txt" style="position:absolute; left:101px; top:43115px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">how the deposit() step typically breaks down into</span></div>
<div class="txt" style="position:absolute; left:101px; top:43163px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">low-level processor instructions:</span></div>
<div class="txt" style="position:absolute; left:65px; top:43234px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">When A and B are running concurrently, these</span></div>
<div class="txt" style="position:absolute; left:101px; top:43283px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">low-level instructions interleave with each other...</span></div>
<div class="txt" style="position:absolute; left:65px; top:43351px;"><span id="f32" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">低层的指令间存在交叉</span></div>
<img id="background" style="position:absolute; left:0px; top:43969px;" width="1440" height="1080" src="page38.png"> <img id="background" style="position:absolute; left:1440px; top:43969px;" width="1440" height="1080" src="page-000038.png">
<div class="txt" style="position:absolute; left:33px; top:44071px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Race Condition </span><span id="f13" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">竞争条件</span></div>
<div class="txt" style="position:absolute; left:899px; top:43987px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:44216px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The balance is now 1 </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">– A’s dollar was lost!</span></div>
<div class="txt" style="position:absolute; left:112px; top:44283px;"><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A and B both read the balance at the</span></div>
<div class="txt" style="position:absolute; left:148px; top:44326px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">same time, computed separate final</span></div>
<div class="txt" style="position:absolute; left:148px; top:44369px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">balances, and then raced to store back</span></div>
<div class="txt" style="position:absolute; left:148px; top:44412px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">the new balance </span><span id="f28" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">which failed to take</span></div>
<div class="txt" style="position:absolute; left:148px; top:44456px;"><span id="f28" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">the other’s deposit into account.</span></div>
<div class="txt" style="position:absolute; left:76px; top:44521px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">This is called </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">race condition</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">: the correctness of the program (the</span></div>
<div class="txt" style="position:absolute; left:112px; top:44571px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">satisfaction of postconditions and invariants) depends on the relative</span></div>
<div class="txt" style="position:absolute; left:112px; top:44619px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">timing of events in concurrent computations A and B. When this</span></div>
<div class="txt" style="position:absolute; left:112px; top:44667px;"><span id="f28" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">happens, we say “A is in a race with B.” ,or called “Thread</span></div>
<div class="txt" style="position:absolute; left:112px; top:44710px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Interference. </span><span id="f41" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">竞争条件：程序的正确性（后置条件和不变性的满足）取</span></div>
<div class="txt" style="position:absolute; left:112px; top:44759px;"><span id="f41" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">决于并发计算</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">A</span><span id="f41" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">和</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">B</span><span id="f41" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">中事件的相对时间</span></div>
<div class="txt" style="position:absolute; left:76px; top:44833px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Some interleavings of events may be OK, in the sense that they are</span></div>
<div class="txt" style="position:absolute; left:112px; top:44883px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">consistent with what a single, nonconcurrent process would produce,</span></div>
<div class="txt" style="position:absolute; left:112px; top:44931px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">but other interleavings produce wrong answers </span><span id="f28" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">violating</span></div>
<div class="txt" style="position:absolute; left:112px; top:44977px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">postconditions or invariants. </span><span id="f41" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">在有些情况下会导致违反后置条件和不变性</span></div>
<img id="background" style="position:absolute; left:0px; top:45156px;" width="1440" height="1080" src="page39.png"> <img id="background" style="position:absolute; left:1440px; top:45156px;" width="1440" height="1080" src="page-000039.png">
<div class="txt" style="position:absolute; left:899px; top:45174px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:45258px;"><span id="f12" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Tweaking the code won’t help </span><span id="f14" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">调整代码无济于事</span></div>
<div class="txt" style="position:absolute; left:76px; top:46051px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">All these versions of the bank-account code exhibit the same race</span></div>
<div class="txt" style="position:absolute; left:112px; top:46101px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">condition.</span></div>
<img id="background" style="position:absolute; left:0px; top:46343px;" width="1440" height="1080" src="page40.png"> <img id="background" style="position:absolute; left:1440px; top:46343px;" width="1440" height="1080" src="page-000040.png">
<div class="txt" style="position:absolute; left:899px; top:46361px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:46445px;"><span id="f12" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Tweaking the code won’t help </span><span id="f14" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">调整代码无济于事</span></div>
<div class="txt" style="position:absolute; left:76px; top:46590px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">You can’t tell just from looking at Java code how the processor is</span></div>
<div class="txt" style="position:absolute; left:112px; top:46635px;"><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">going to execute it.</span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">不能仅仅从</span><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Java</span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">代码中看出处理器将如何执行它</span></div>
<div class="txt" style="position:absolute; left:116px; top:46712px;"><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">balance += 1;</span></div>
<div class="txt" style="position:absolute; left:116px; top:46783px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The problem is that these are not </span><span id="f31" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,0,1);">atomic </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">operations. The instruction</span></div>
<div class="txt" style="position:absolute; left:76px; top:46827px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">might be processed as follows: </span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">本质原因是它们不是原子操作</span></div>
<div class="txt" style="position:absolute; left:106px; top:46904px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">1. Load balance into a register.</span></div>
<div class="txt" style="position:absolute; left:106px; top:46976px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">2. Add 1.</span></div>
<div class="txt" style="position:absolute; left:106px; top:47048px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">3. Move the result back to balance.</span></div>
<div class="txt" style="position:absolute; left:76px; top:47118px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The key lesson is that you can’t tell by looking at an expression</span></div>
<div class="txt" style="position:absolute; left:112px; top:47163px;"><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">whether it will be safe from race conditions </span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">无法通过观察一个表达</span></div>
<div class="txt" style="position:absolute; left:112px; top:47211px;"><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">式来判断它是否会在竞争状态下安全</span></div>
<img id="background" style="position:absolute; left:0px; top:47530px;" width="1440" height="1080" src="page41.png"> <img id="background" style="position:absolute; left:1440px; top:47530px;" width="1440" height="1080" src="page-000041.png">
<div class="txt" style="position:absolute; left:33px; top:47637px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Reordering</span></div>
<div class="txt" style="position:absolute; left:899px; top:47548px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:47777px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The race condition on the bank account balance can be explained in</span></div>
<div class="txt" style="position:absolute; left:112px; top:47827px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">terms of different interleavings of sequential operations on different</span></div>
<div class="txt" style="position:absolute; left:112px; top:47870px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">processors. </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">银行账户的这个例子中的竞争情况，可以用顺序操作在不</span></div>
<div class="txt" style="position:absolute; left:112px; top:47918px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">同处理器上的不同交叉执行解释</span></div>
<div class="txt" style="position:absolute; left:76px; top:47993px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">But in fact, when you’re using multiple variables and multiple</span></div>
<div class="txt" style="position:absolute; left:112px; top:48043px;"><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">processors, you can’t even count on changes to those variables</span></div>
<div class="txt" style="position:absolute; left:112px; top:48086px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">appearing in the same order. </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">但是事实上，当使用多个变量和多个处</span></div>
<div class="txt" style="position:absolute; left:112px; top:48134px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">理器时，甚至不能指望这些变量的变化以相同的顺序出现</span></div>
<img id="background" style="position:absolute; left:0px; top:48717px;" width="1440" height="1080" src="page42.png"> <img id="background" style="position:absolute; left:1440px; top:48717px;" width="1440" height="1080" src="page-000042.png">
<div class="txt" style="position:absolute; left:33px; top:48824px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Reordering</span></div>
<div class="txt" style="position:absolute; left:899px; top:48735px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:48964px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Looking at the code, answer is set before ready is set, so once</span></div>
<div class="txt" style="position:absolute; left:112px; top:49014px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">useAnswer sees ready as true, then it seems reasonable that it can</span></div>
<div class="txt" style="position:absolute; left:112px; top:49062px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">assume that the answer will be 42, right? </span><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">Not so</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">.</span></div>
<img id="background" style="position:absolute; left:0px; top:49904px;" width="1440" height="1080" src="page43.png"> <img id="background" style="position:absolute; left:1440px; top:49904px;" width="1440" height="1080" src="page-000043.png">
<div class="txt" style="position:absolute; left:33px; top:50011px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Reordering</span></div>
<div class="txt" style="position:absolute; left:899px; top:49922px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:50151px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The problem is that modern compilers and processors do a lot of things</span></div>
<div class="txt" style="position:absolute; left:112px; top:50201px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">to make the code fast. One of those things is </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">making temporary copies</span></div>
<div class="txt" style="position:absolute; left:112px; top:50249px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">of variables </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">like answer and ready </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">in faster storage </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">(processor</span></div>
<div class="txt" style="position:absolute; left:112px; top:50297px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">registers, or processor caches), and working with them temporarily</span></div>
<div class="txt" style="position:absolute; left:112px; top:50345px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">before eventually storing them back to their official location in</span></div>
<div class="txt" style="position:absolute; left:112px; top:50388px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">memory. </span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">出于优化目的，编译器和处理器会复制变量的临时副本在高速</span></div>
<div class="txt" style="position:absolute; left:112px; top:50436px;"><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">存储中，在存储回正式内存位置之前，基于临时副本工作</span></div>
<div class="txt" style="position:absolute; left:76px; top:50511px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The storeback may occur in a different order than the variables were</span></div>
<div class="txt" style="position:absolute; left:112px; top:50556px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">manipulated in your code. </span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">存储回内存的顺序，可能与代码中操作的变</span></div>
<div class="txt" style="position:absolute; left:112px; top:50604px;"><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">量顺序不同</span></div>
<img id="background" style="position:absolute; left:0px; top:51091px;" width="1440" height="1080" src="page44.png"> <img id="background" style="position:absolute; left:1440px; top:51091px;" width="1440" height="1080" src="page-000044.png">
<div class="txt" style="position:absolute; left:33px; top:51198px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Reordering</span></div>
<div class="txt" style="position:absolute; left:899px; top:51109px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:51338px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The processor is effectively creating two temporary</span></div>
<div class="txt" style="position:absolute; left:112px; top:51388px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">variables, tmpr and tmpa, to manipulate the fields ready and answer:</span></div>
<img id="background" style="position:absolute; left:0px; top:52278px;" width="1440" height="1080" src="page45.png"> <img id="background" style="position:absolute; left:1440px; top:52278px;" width="1440" height="1080" src="page-000045.png">
<div class="txt" style="position:absolute; left:33px; top:52385px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Message Passing Example</span></div>
<div class="txt" style="position:absolute; left:899px; top:52296px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:52525px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Now not only are the cash machine modules, but the accounts are</span></div>
<div class="txt" style="position:absolute; left:112px; top:52570px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">modules, too. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">不仅自动取款机是处理模块，账户也是处理模块</span></div>
<div class="txt" style="position:absolute; left:76px; top:52642px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Modules interact by sending messages to each other. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">模块间通过消</span></div>
<div class="txt" style="position:absolute; left:112px; top:52690px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">息传递进行交互</span></div>
<div class="txt" style="position:absolute; left:112px; top:52760px;"><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Incoming requests are placed in a queue to be handled one at a time.</span></div>
<div class="txt" style="position:absolute; left:112px; top:52820px;"><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f38" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The sender doesn’t stop working while waiting for an answer to its</span></div>
<div class="txt" style="position:absolute; left:148px; top:52863px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">request. It handles more requests from its own queue. The reply to its</span></div>
<div class="txt" style="position:absolute; left:148px; top:52903px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">request eventually comes back as another message. </span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">消息接收方将收到的消</span></div>
<div class="txt" style="position:absolute; left:148px; top:52946px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">息形成队列逐一处理</span><span id="f47" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">(</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">先进先出</span><span id="f47" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">) </span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">，消息发送者并不停下来等待结果而是继</span></div>
<div class="txt" style="position:absolute; left:148px; top:52989px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">续执行</span><span id="f47" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">(</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">异步方式</span><span id="f47" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">)</span></div>
<img id="background" style="position:absolute; left:0px; top:53465px;" width="1440" height="1080" src="page46.png"> <img id="background" style="position:absolute; left:1440px; top:53465px;" width="1440" height="1080" src="page-000046.png">
<div class="txt" style="position:absolute; left:899px; top:53483px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:53572px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Can message-passing solve race condition?</span></div>
<div class="txt" style="position:absolute; left:76px; top:53712px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Unfortunately, message passing doesn’t eliminate the possibility</span></div>
<div class="txt" style="position:absolute; left:112px; top:53757px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">of race conditions. </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">消息传递的方式并不能消除竞争条件的可能性</span></div>
<div class="txt" style="position:absolute; left:76px; top:53832px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Suppose each account supports get-balance and withdraw</span></div>
<div class="txt" style="position:absolute; left:112px; top:53882px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">operations, with corresponding messages.</span></div>
<div class="txt" style="position:absolute; left:112px; top:53947px;"><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Two users, at cash machines A and B, are both trying to withdraw a dollar</span></div>
<div class="txt" style="position:absolute; left:148px; top:53986px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">from the same account. </span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">A</span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">和</span><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">B</span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">首先查询余额，然后取款，避免透支</span></div>
<div class="txt" style="position:absolute; left:112px; top:54050px;"><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">They check the balance first to make sure they never withdraw more than</span></div>
<div class="txt" style="position:absolute; left:148px; top:54094px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">the account holds, because overdrafts trigger big bank penalties.</span></div>
<img id="background" style="position:absolute; left:0px; top:54652px;" width="1440" height="1080" src="page47.png"> <img id="background" style="position:absolute; left:1440px; top:54652px;" width="1440" height="1080" src="page-000047.png">
<div class="txt" style="position:absolute; left:899px; top:54670px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:54759px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Can message-passing solve race condition?</span></div>
<div class="txt" style="position:absolute; left:76px; top:54899px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The problem is again interleaving, but this time interleaving of</span></div>
<div class="txt" style="position:absolute; left:112px; top:54948px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">the </span><span id="f20" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,0,1);">messages </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">sent to the bank account, rather than the</span></div>
<div class="txt" style="position:absolute; left:112px; top:54992px;"><span id="f20" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,0,1);">instructions </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">executed by A and B. </span><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">交叉的问题仍然会出现，但是这次</span></div>
<div class="txt" style="position:absolute; left:112px; top:55040px;"><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">交叉信息发生在银行账户，而不是</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">A</span><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">和</span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">B</span><span id="f26" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">执行的指令。</span></div>
<div class="txt" style="position:absolute; left:112px; top:55110px;"><span id="f42" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">If the account starts with a dollar in it, then what interleaving of messages</span></div>
<div class="txt" style="position:absolute; left:148px; top:55153px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">will fool A and B into thinking they can both withdraw a dollar, thereby</span></div>
<div class="txt" style="position:absolute; left:148px; top:55196px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">overdrawing the account?</span></div>
<img id="background" style="position:absolute; left:0px; top:55839px;" width="1440" height="1080" src="page48.png"> <img id="background" style="position:absolute; left:1440px; top:55839px;" width="1440" height="1080" src="page-000048.png">
<div class="txt" style="position:absolute; left:899px; top:55857px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:55946px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Can message-passing solve race condition?</span></div>
<div class="txt" style="position:absolute; left:76px; top:56086px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">One lesson here is that you need to carefully choose the operations</span></div>
<div class="txt" style="position:absolute; left:112px; top:56135px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">of a message-passing model. </span><span id="f22" style="font-size:37px;vertical-align:baseline;color:rgba(255,0,0,1);">withdraw-if-sufficient-funds </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">would be</span></div>
<div class="txt" style="position:absolute; left:112px; top:56179px;"><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">a better operation than just withdraw. </span><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">需要仔细选择消息传递模型的</span></div>
<div class="txt" style="position:absolute; left:112px; top:56227px;"><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">操作， </span><span id="f22" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,255,1);">withdraw-if-sufficient-funds </span><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">比单纯的</span><span id="f22" style="font-size:37px;vertical-align:baseline;color:rgba(0,0,255,1);">withdraw</span><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">更加适合</span></div>
<img id="background" style="position:absolute; left:0px; top:57026px;" width="1440" height="1080" src="page49.png"> <img id="background" style="position:absolute; left:1440px; top:57026px;" width="1440" height="1080" src="page-000049.png">
<div class="txt" style="position:absolute; left:33px; top:57133px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(255,0,0,1);">happens-before </span><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">relationship</span></div>
<div class="txt" style="position:absolute; left:899px; top:57044px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:57273px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">In computer science, the </span><span id="f20" style="font-size:37px;vertical-align:baseline;color:rgba(255,0,0,1);">happened-before </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">relation is a relation</span></div>
<div class="txt" style="position:absolute; left:112px; top:57323px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">between the result of two events, such that if one event should</span></div>
<div class="txt" style="position:absolute; left:112px; top:57371px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">happen before another event, the result must reflect that, even if</span></div>
<div class="txt" style="position:absolute; left:112px; top:57419px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">those events are in reality executed out of order (usually to</span></div>
<div class="txt" style="position:absolute; left:112px; top:57462px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">optimize program flow). </span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">前一个事件的结果可以被后续的事件获取</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">(</span></div>
<div class="txt" style="position:absolute; left:112px; top:57510px;"><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">即使出于优化的目的，实际运行中并不是按照指定顺序执行</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">)</span></div>
<div class="txt" style="position:absolute; left:76px; top:57585px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">In Java, a </span><span id="f20" style="font-size:37px;vertical-align:baseline;color:rgba(255,0,0,1);">happens-before </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">relationship is simply a guarantee that</span></div>
<div class="txt" style="position:absolute; left:112px; top:57635px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">memory written to by statement A is visible to statement B, that is,</span></div>
<div class="txt" style="position:absolute; left:112px; top:57683px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">that statement A completes its write before statement B starts its</span></div>
<div class="txt" style="position:absolute; left:112px; top:57726px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">read. </span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">在</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Java</span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">中，采用</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">happened-before</span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">机制，保证了语句</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">A</span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">对内存的</span></div>
<div class="txt" style="position:absolute; left:112px; top:57774px;"><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">写入对语句</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">B</span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">是可见的，也就是在</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">B</span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">开始读数据之前，</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">A</span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">已经完成了数</span></div>
<div class="txt" style="position:absolute; left:112px; top:57822px;"><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">据的写入</span></div>
<div class="txt" style="position:absolute; left:76px; top:57894px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">This is to ensure Memory Consistency. </span><span id="f30" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">确保内存一致性</span></div>
<img id="background" style="position:absolute; left:0px; top:58213px;" width="1440" height="1080" src="page50.png"> <img id="background" style="position:absolute; left:1440px; top:58213px;" width="1440" height="1080" src="page-000050.png">
<div class="txt" style="position:absolute; left:899px; top:58231px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:58320px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Concurrency is hard to test and debug !</span></div>
<div class="txt" style="position:absolute; left:76px; top:58457px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">It’s very hard to discover race conditions using testing. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">难以定位</span></div>
<div class="txt" style="position:absolute; left:112px; top:58527px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Even once a test has found a bug, it may be very hard to localize it to the</span></div>
<div class="txt" style="position:absolute; left:148px; top:58570px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">part of the program causing it. ----WHY?</span></div>
<div class="txt" style="position:absolute; left:76px; top:58633px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f27" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Concurrency bugs exhibit very poor reproducibility. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">难以重现</span></div>
<div class="txt" style="position:absolute; left:112px; top:58702px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f32" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">It’s hard to make them happen the same way twice.</span></div>
<div class="txt" style="position:absolute; left:112px; top:58763px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Interleaving of instructions or messages depends </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">on the relative timing of</span></div>
<div class="txt" style="position:absolute; left:148px; top:58806px;"><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">events </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">that are strongly influenced by the environment.</span></div>
<div class="txt" style="position:absolute; left:112px; top:58867px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Delays are caused by other running programs, other network traffic, OS</span></div>
<div class="txt" style="position:absolute; left:148px; top:58910px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">scheduling decisions, variations in processor clock speed, etc.</span></div>
<div class="txt" style="position:absolute; left:112px; top:58970px;"><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Each time you run a program containing a race condition, you may get</span></div>
<div class="txt" style="position:absolute; left:148px; top:59010px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">different behavior.</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">每次运行包含竞争条件的程序时，都可能会得到不同的</span></div>
<div class="txt" style="position:absolute; left:148px; top:59053px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">行为。</span></div>
<div class="txt" style="position:absolute; left:312px; top:59136px;"><span id="f49" style="font-size:44px;vertical-align:baseline;color:rgba(255,255,255,1);">Heisenbugs</span></div>
<div class="txt" style="position:absolute; left:723px; top:59146px;"><span id="f53" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Vs.</span></div>
<div class="txt" style="position:absolute; left:967px; top:59136px;"><span id="f49" style="font-size:44px;vertical-align:baseline;color:rgba(255,255,255,1);">Bohrbugs</span></div>
<div class="txt" style="position:absolute; left:110px; top:59253px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(50,50,50,1);">nondeterministic and hard to reproduce</span></div>
<div class="txt" style="position:absolute; left:927px; top:59249px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(50,50,50,1);">shows up repeatedly</span></div>
<img id="background" style="position:absolute; left:0px; top:59400px;" width="1440" height="1080" src="page51.png"> <img id="background" style="position:absolute; left:1440px; top:59400px;" width="1440" height="1080" src="page-000051.png">
<div class="txt" style="position:absolute; left:899px; top:59418px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:59507px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Concurrency is hard to test and debug !</span></div>
<div class="txt" style="position:absolute; left:76px; top:59647px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">A heisenbug may even disappear when you try to look at it with</span></div>
<div class="txt" style="position:absolute; left:112px; top:59692px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">println or debugger! </span><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">当尝试用</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">println</span><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">或调试器查看</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">heisenbug</span><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">时，甚</span></div>
<div class="txt" style="position:absolute; left:112px; top:59740px;"><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">至可能会消失！</span></div>
<div class="txt" style="position:absolute; left:112px; top:59810px;"><span id="f32" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The reason is that printing and debugging are so much slower than other</span></div>
<div class="txt" style="position:absolute; left:148px; top:59853px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">operations, often 100-1000x slower, that they dramatically change the</span></div>
<div class="txt" style="position:absolute; left:148px; top:59892px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">timing of operations, and the interleaving. </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">Debugger</span><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">的速度比其他操作慢</span></div>
<div class="txt" style="position:absolute; left:76px; top:59962px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">So inserting a simple print statement into the </span><span id="f45" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">cashMachine()</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">:</span></div>
<div class="txt" style="position:absolute; left:76px; top:60252px;"><span id="f49" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">…and suddenly the balance is always 0, as desired, and the bug</span></div>
<div class="txt" style="position:absolute; left:76px; top:60300px;"><span id="f49" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">appears to disappear. But it’s only masked, not truly fixed. A change in</span></div>
<div class="txt" style="position:absolute; left:76px; top:60348px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">timing somewhere else in the program may suddenly make the bug</span></div>
<div class="txt" style="position:absolute; left:76px; top:60391px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">come back. </span><span id="f20" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">通常情况下正确，但有时还会出现问题</span></div>
<img id="background" style="position:absolute; left:0px; top:60587px;" width="1440" height="1080" src="page52.png"> <img id="background" style="position:absolute; left:1440px; top:60587px;" width="1440" height="1080" src="page-000052.png">
<div class="txt" style="position:absolute; left:33px; top:60694px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">A short summary</span></div>
<div class="txt" style="position:absolute; left:899px; top:60605px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:60834px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Concurrency</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">: multiple computations running simultaneously</span></div>
<div class="txt" style="position:absolute; left:76px; top:60906px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Shared-memory </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">&amp; </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">message-passing </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">paradigms</span></div>
<div class="txt" style="position:absolute; left:76px; top:60978px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Processes </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">&amp; </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">threads</span></div>
<div class="txt" style="position:absolute; left:112px; top:61045px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Process is like a virtual computer; thread is like a virtual processor</span></div>
<div class="txt" style="position:absolute; left:76px; top:61110px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Race conditions</span></div>
<div class="txt" style="position:absolute; left:112px; top:61177px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">When correctness of result (postconditions and invariants) depends on the</span></div>
<div class="txt" style="position:absolute; left:148px; top:61220px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">relative timing of events</span></div>
<div class="txt" style="position:absolute; left:112px; top:61281px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Multiple threads </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">sharing the same mutable variable </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">without coordinating</span></div>
<div class="txt" style="position:absolute; left:148px; top:61324px;"><span id="f46" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">what they’re doing.</span></div>
<div class="txt" style="position:absolute; left:112px; top:61385px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">This is unsafe, because the correctness of the program may depend on</span></div>
<div class="txt" style="position:absolute; left:148px; top:61428px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">accidents of timing of their low-level operations.</span></div>
<img id="background" style="position:absolute; left:0px; top:61774px;" width="1440" height="1080" src="page53.png"> <img id="background" style="position:absolute; left:1440px; top:61774px;" width="1440" height="1080" src="page-000053.png">
<div class="txt" style="position:absolute; left:1105px; top:61792px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:471px; top:62189px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">4 Thread Safety</span></div>
<img id="background" style="position:absolute; left:0px; top:62961px;" width="1440" height="1080" src="page54.png"> <img id="background" style="position:absolute; left:1440px; top:62961px;" width="1440" height="1080" src="page-000054.png">
<div class="txt" style="position:absolute; left:899px; top:62979px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:63063px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">What does </span><span id="f13" style="font-size:39px;vertical-align:baseline;color:rgba(255,0,0,1);">threadsafe </span><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">mean</span><span id="f16" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">？</span></div>
<div class="txt" style="position:absolute; left:65px; top:63196px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">A data type or static method is threadsafe if it behaves correctly</span></div>
<div class="txt" style="position:absolute; left:101px; top:63246px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">when used from multiple threads, regardless of how those threads</span></div>
<div class="txt" style="position:absolute; left:101px; top:63294px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">are executed, and without demanding additional coordination from</span></div>
<div class="txt" style="position:absolute; left:101px; top:63342px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">the calling code. </span><span id="f27" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">数据类型或静态方法在多线程中执行时，无论如何执行，不需调</span></div>
<div class="txt" style="position:absolute; left:101px; top:63385px;"><span id="f27" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">用者做额外的协作，仍然能够行为正确，则称为线程安全的</span></div>
<div class="txt" style="position:absolute; left:101px; top:63444px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">“</span><span id="f35" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">behaves correctly</span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">” means satisfying its specification and preserving its</span></div>
<div class="txt" style="position:absolute; left:137px; top:63484px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">rep invariant; </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">行为正确意味着满足规格说明和保持不变性</span></div>
<div class="txt" style="position:absolute; left:101px; top:63548px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">“</span><span id="f35" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">regardless of how threads are executed</span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">” means threads might be on</span></div>
<div class="txt" style="position:absolute; left:137px; top:63591px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">multiple processors or time sliced on the same processor;</span></div>
<div class="txt" style="position:absolute; left:101px; top:63652px;"><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">“</span><span id="f35" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">without additional coordination</span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">” means that the data type can’t put</span></div>
<div class="txt" style="position:absolute; left:137px; top:63695px;"><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">preconditions on its caller related to timing, like “you can’t call </span><span id="f13" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">get()</span></div>
<div class="txt" style="position:absolute; left:137px; top:63734px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">while </span><span id="f13" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">set() </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">is in progress.” </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">不能在前置条件中对调用者增加时间性要求</span></div>
<div class="txt" style="position:absolute; left:65px; top:63804px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f35" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Remember </span><span id="f13" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">Iterator</span><span id="f35" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">? </span><span id="f61" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">It’s not </span><span id="f35" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">threadsafe. </span><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Iterator ’s specification</span></div>
<div class="txt" style="position:absolute; left:101px; top:63854px;"><span id="f61" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">says that you can’t modify a collection at the same time as you’re</span></div>
<div class="txt" style="position:absolute; left:101px; top:63902px;"><span id="f35" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">iterating over it</span><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">(except using the iterator’s own remove method)..</span></div>
<div class="txt" style="position:absolute; left:101px; top:63950px;"><span id="f33" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">That’s a timing</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">-related precondition put on the caller, and Iterator</span></div>
<div class="txt" style="position:absolute; left:101px; top:63998px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">makes no guarantee to behave correctly if you violate it.</span></div>
<img id="background" style="position:absolute; left:0px; top:64148px;" width="1440" height="1080" src="page55.png"> <img id="background" style="position:absolute; left:1440px; top:64148px;" width="1440" height="1080" src="page-000055.png">
<div class="txt" style="position:absolute; left:33px; top:64255px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Four ways of threadsafe</span></div>
<div class="txt" style="position:absolute; left:899px; top:64166px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:134px; top:64397px;"><span id="f69" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">Don’t share</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">: isolate</span></div>
<div class="txt" style="position:absolute; left:163px; top:64441px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">mutable state in</span></div>
<div class="txt" style="position:absolute; left:143px; top:64484px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">individual threads</span></div>
<div class="txt" style="position:absolute; left:132px; top:64623px;"><span id="f69" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">Don’t mutate</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">: share</span></div>
<div class="txt" style="position:absolute; left:124px; top:64666px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">only immutable state</span></div>
<div class="txt" style="position:absolute; left:113px; top:64929px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">If must share mutable</span></div>
<div class="txt" style="position:absolute; left:141px; top:64973px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">state, </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(255,255,255,1);">synchronize</span></div>
<div class="txt" style="position:absolute; left:553px; top:64383px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Confinement. </span><span id="f17" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Don’t share the mutable</span></div>
<div class="txt" style="position:absolute; left:589px; top:64432px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">variable between threads. </span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">限制可变变量的共享</span></div>
<div class="txt" style="position:absolute; left:553px; top:64504px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Immutability. </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Make the shared data</span></div>
<div class="txt" style="position:absolute; left:589px; top:64553px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">immutable. There are some additional</span></div>
<div class="txt" style="position:absolute; left:589px; top:64601px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">constraints for concurrent programming.</span></div>
<div class="txt" style="position:absolute; left:593px; top:64652px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">用不可变的共享变量</span></div>
<div class="txt" style="position:absolute; left:553px; top:64720px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Threadsafe data type. </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Encapsulate the</span></div>
<div class="txt" style="position:absolute; left:589px; top:64769px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">shared data in an existing threadsafe data</span></div>
<div class="txt" style="position:absolute; left:589px; top:64813px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">type that does the coordination for you. </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">将共</span></div>
<div class="txt" style="position:absolute; left:589px; top:64861px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">享数据封装在线程安全的数据类型中</span></div>
<div class="txt" style="position:absolute; left:553px; top:64936px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Synchronization. </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Use synchronization to</span></div>
<div class="txt" style="position:absolute; left:589px; top:64985px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">keep the threads from accessing the variable</span></div>
<div class="txt" style="position:absolute; left:589px; top:65033px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">at the same time. Synchronization is what</span></div>
<div class="txt" style="position:absolute; left:589px; top:65081px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">you need to build your own threadsafe data</span></div>
<div class="txt" style="position:absolute; left:589px; top:65125px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">type.</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">使用同步机制来防止线程同时使用变量</span></div>
<img id="background" style="position:absolute; left:0px; top:65335px;" width="1440" height="1080" src="page56.png"> <img id="background" style="position:absolute; left:1440px; top:65335px;" width="1440" height="1080" src="page-000056.png">
<div class="txt" style="position:absolute; left:1105px; top:65353px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:334px; top:65750px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 1: Confinement</span></div>
<img id="background" style="position:absolute; left:0px; top:66522px;" width="1440" height="1080" src="page57.png"> <img id="background" style="position:absolute; left:1440px; top:66522px;" width="1440" height="1080" src="page-000057.png">
<div class="txt" style="position:absolute; left:33px; top:66629px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 1: Confinement</span></div>
<div class="txt" style="position:absolute; left:899px; top:66540px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:66769px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Thread confinement is a simple idea:</span></div>
<div class="txt" style="position:absolute; left:112px; top:66836px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">You avoid races on mutable data by keeping that data confined to a single</span></div>
<div class="txt" style="position:absolute; left:148px; top:66875px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">thread. </span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">通过将数据限制在单个线程中，可以避免线程在可变数据上进行竞争</span></div>
<div class="txt" style="position:absolute; left:112px; top:66939px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Don’t give any other threads the ability to read or write the data directly.</span></div>
<div class="txt" style="position:absolute; left:76px; top:67005px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Since shared mutable data is the root cause of a race condition,</span></div>
<div class="txt" style="position:absolute; left:112px; top:67054px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">confinement solves it by </span><span id="f34" style="font-size:37px;vertical-align:baseline;color:rgba(255,0,0,1);">not sharing the mutable data.</span></div>
<div class="txt" style="position:absolute; left:112px; top:67120px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Local variables are always thread confined. A local variable is stored in the</span></div>
<div class="txt" style="position:absolute; left:148px; top:67163px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">stack, and each thread has its own stack. There may be multiple invocations</span></div>
<div class="txt" style="position:absolute; left:148px; top:67206px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">of a method running at a time, but each of those invocations has its own</span></div>
<div class="txt" style="position:absolute; left:148px; top:67245px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">private copy of the variable, so the variable itself is confined. </span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">局部变量保存在</span></div>
<div class="txt" style="position:absolute; left:148px; top:67289px;"><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">线程栈中，每个调用都有自己的变量副本</span></div>
<div class="txt" style="position:absolute; left:112px; top:67353px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">If a local variable is an object reference, you need to check the object it points</span></div>
<div class="txt" style="position:absolute; left:148px; top:67396px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">to. If the object is mutable, then we want to check that the object is confined</span></div>
<div class="txt" style="position:absolute; left:148px; top:67440px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">as well </span><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– there can’t be references to it that are reachable from any other</span></div>
<div class="txt" style="position:absolute; left:148px; top:67479px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">thread. </span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">局部变量如果是对象的引用，则要确保不能引用任何其他线程可访问</span></div>
<div class="txt" style="position:absolute; left:148px; top:67522px;"><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">的对象</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">(</span><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">针对可变对象</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">)</span></div>
<img id="background" style="position:absolute; left:0px; top:67709px;" width="1440" height="1080" src="page58.png"> <img id="background" style="position:absolute; left:1440px; top:67709px;" width="1440" height="1080" src="page-000058.png">
<div class="txt" style="position:absolute; left:33px; top:67816px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 1: Confinement</span></div>
<div class="txt" style="position:absolute; left:33px; top:68045px;"><span id="f14" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Each execution of</span></div>
<div class="txt" style="position:absolute; left:69px; top:68085px;"><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">computeFact </span><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(255,0,0,1);">has its own</span></div>
<div class="txt" style="position:absolute; left:69px; top:68124px;"><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(255,0,0,1);">n, i, and result variables.</span></div>
<div class="txt" style="position:absolute; left:33px; top:68180px;"><span id="f14" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">None of the objects they</span></div>
<div class="txt" style="position:absolute; left:69px; top:68220px;"><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">point to are mutable;</span></div>
<div class="txt" style="position:absolute; left:33px; top:68276px;"><span id="f14" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">The computeFact</span></div>
<div class="txt" style="position:absolute; left:69px; top:68316px;"><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">computations proceed</span></div>
<div class="txt" style="position:absolute; left:69px; top:68354px;"><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">independently,</span></div>
<div class="txt" style="position:absolute; left:69px; top:68393px;"><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">updating their</span></div>
<div class="txt" style="position:absolute; left:69px; top:68431px;"><span id="f16" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">respective variables.</span></div>
<div class="txt" style="position:absolute; left:899px; top:67727px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<img id="background" style="position:absolute; left:0px; top:68896px;" width="1440" height="1080" src="page59.png"> <img id="background" style="position:absolute; left:1440px; top:68896px;" width="1440" height="1080" src="page-000059.png">
<div class="txt" style="position:absolute; left:33px; top:69003px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Avoid Global Variables</span></div>
<div class="txt" style="position:absolute; left:899px; top:68914px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:69140px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Global static variables are not automatically thread confined. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">全局</span></div>
<div class="txt" style="position:absolute; left:112px; top:69188px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">静态变量不会自动受到线程访问限制</span></div>
<div class="txt" style="position:absolute; left:112px; top:69258px;"><span id="f22" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">If you have static variables in your program, then you have to make an</span></div>
<div class="txt" style="position:absolute; left:148px; top:69301px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">argument that only one thread will ever use them, and you have to</span></div>
<div class="txt" style="position:absolute; left:148px; top:69341px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">document that fact clearly. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">如果使用了全局静态变量，则应说明只允</span></div>
<div class="txt" style="position:absolute; left:148px; top:69389px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">许一个线程使用它们</span></div>
<div class="txt" style="position:absolute; left:76px; top:69461px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Better, you should eliminate the static variables entirely. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">在多线程</span></div>
<div class="txt" style="position:absolute; left:112px; top:69509px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">环境中，取消全局变量</span></div>
<img id="background" style="position:absolute; left:0px; top:70083px;" width="1440" height="1080" src="page60.png"> <img id="background" style="position:absolute; left:1440px; top:70083px;" width="1440" height="1080" src="page-000060.png">
<div class="txt" style="position:absolute; left:33px; top:70190px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Avoid Global Variables</span></div>
<div class="txt" style="position:absolute; left:899px; top:70101px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:70330px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">E.g., singleton pattern</span></div>
<div class="txt" style="position:absolute; left:76px; top:70402px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">This class has a race in the </span><span id="f19" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">getInstance() </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">method </span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">two threads</span></div>
<div class="txt" style="position:absolute; left:112px; top:70452px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">could call it at the same time and end up creating two copies of the</span></div>
<div class="txt" style="position:absolute; left:112px; top:70499px;"><span id="f19" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">PinballSimulator </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">object, which violates the rep invariant.</span></div>
<div class="txt" style="position:absolute; left:927px; top:70579px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">两个线程如果同时调用</span></div>
<div class="txt" style="position:absolute; left:963px; top:70620px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">getInstance() </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">会导致产生两</span></div>
<div class="txt" style="position:absolute; left:963px; top:70663px;"><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">个实例，破坏了表示不变性</span></div>
<div class="txt" style="position:absolute; left:927px; top:70730px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">To fix this race using the</span></div>
<div class="txt" style="position:absolute; left:963px; top:70775px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">thread confinement</span></div>
<div class="txt" style="position:absolute; left:963px; top:70818px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">approach, you would</span></div>
<div class="txt" style="position:absolute; left:963px; top:70861px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">specify that only a certain</span></div>
<div class="txt" style="position:absolute; left:963px; top:70905px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">thread is allowed to call</span></div>
<div class="txt" style="position:absolute; left:963px; top:70944px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">getInstance(). </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">如果采用限</span></div>
<div class="txt" style="position:absolute; left:963px; top:70990px;"><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">制的方式，要自行确保只有</span></div>
<div class="txt" style="position:absolute; left:963px; top:71030px;"><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">一个线程访问</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">getInstance()</span></div>
<div class="txt" style="position:absolute; left:927px; top:71095px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">也可采用</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronized</span><span id="f33" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">方式</span></div>
<img id="background" style="position:absolute; left:0px; top:71270px;" width="1440" height="1080" src="page61.png"> <img id="background" style="position:absolute; left:1440px; top:71270px;" width="1440" height="1080" src="page-000061.png">
<div class="txt" style="position:absolute; left:33px; top:71377px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Avoid Global Variables</span></div>
<div class="txt" style="position:absolute; left:899px; top:71288px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:71517px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">In general, static variables are very risky for concurrency. They</span></div>
<div class="txt" style="position:absolute; left:112px; top:71567px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">might be hiding behind an innocuous function that seems to have</span></div>
<div class="txt" style="position:absolute; left:112px; top:71610px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">no side-effects or mutations.</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">一般来说，静态变量对于并行是非常危</span></div>
<div class="txt" style="position:absolute; left:112px; top:71658px;"><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">险的，它们可能隐藏在似乎没有副作用或改变的无害功能之后</span></div>
<div class="txt" style="position:absolute; left:76px; top:71733px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Consider this example:</span></div>
<div class="txt" style="position:absolute; left:112px; top:71800px;"><span id="f42" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f44" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">This function stores the answers from previous calls in case they’re</span></div>
<div class="txt" style="position:absolute; left:148px; top:71843px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">requested again. This technique is called memorization.</span></div>
<img id="background" style="position:absolute; left:0px; top:72457px;" width="1440" height="1080" src="page62.png"> <img id="background" style="position:absolute; left:1440px; top:72457px;" width="1440" height="1080" src="page-000062.png">
<div class="txt" style="position:absolute; left:33px; top:72564px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Avoid Global Variables</span></div>
<div class="txt" style="position:absolute; left:899px; top:72475px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:72704px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">But now the isPrime method is not safe to call from multiple threads,</span></div>
<div class="txt" style="position:absolute; left:112px; top:72754px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">and its clients may not even realize it.</span></div>
<div class="txt" style="position:absolute; left:76px; top:72824px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The reason is that the </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">HashMap referenced by the static variable</span></div>
<div class="txt" style="position:absolute; left:112px; top:72874px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">cache is shared by all calls to isPrime(), and HashMap is not</span></div>
<div class="txt" style="position:absolute; left:112px; top:72922px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">threadsafe. </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">If multiple threads mutate the map at the same time, by</span></div>
<div class="txt" style="position:absolute; left:112px; top:72970px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">calling cache.put(), then the map can become corrupted in the same</span></div>
<div class="txt" style="position:absolute; left:112px; top:73013px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">way that the bank account became corrupted in the last reading. </span><span id="f44" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">当有</span></div>
<div class="txt" style="position:absolute; left:112px; top:73061px;"><span id="f44" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">多个线程同时执行</span><span id="f49" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">cache.put()</span><span id="f44" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">操作时，</span><span id="f49" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">map</span><span id="f44" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">可能会遭到破坏</span></div>
<div class="txt" style="position:absolute; left:76px; top:73136px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f60" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">If you’re lucky, the corruption may cause an exception deep in the</span></div>
<div class="txt" style="position:absolute; left:112px; top:73186px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">hash map, like a NullPointerException or IndexOutOfBounds-</span></div>
<div class="txt" style="position:absolute; left:112px; top:73234px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Exception. But it also may just quietly give wrong answers, as we</span></div>
<div class="txt" style="position:absolute; left:112px; top:73282px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">saw in the bank account example.</span></div>
<img id="background" style="position:absolute; left:0px; top:73644px;" width="1440" height="1080" src="page63.png"> <img id="background" style="position:absolute; left:1440px; top:73644px;" width="1440" height="1080" src="page-000063.png">
<div class="txt" style="position:absolute; left:1105px; top:73662px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:332px; top:74059px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 2: Immutability</span></div>
<img id="background" style="position:absolute; left:0px; top:74831px;" width="1440" height="1080" src="page64.png"> <img id="background" style="position:absolute; left:1440px; top:74831px;" width="1440" height="1080" src="page-000064.png">
<div class="txt" style="position:absolute; left:33px; top:74938px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 2: Immutability</span></div>
<div class="txt" style="position:absolute; left:899px; top:74849px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:75078px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The second way of achieving thread safety is </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">by using immutable</span></div>
<div class="txt" style="position:absolute; left:112px; top:75123px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">references and data types</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">.</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">使用不可变的引用和数据类型</span></div>
<div class="txt" style="position:absolute; left:112px; top:75193px;"><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Immutability tackles the shared-mutable-data cause of a race condition</span></div>
<div class="txt" style="position:absolute; left:148px; top:75232px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">and solves it simply by making the shared data </span><span id="f35" style="font-size:33px;vertical-align:baseline;color:rgba(255,0,0,1);">not mutable</span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">. </span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">不可变解决了</span></div>
<div class="txt" style="position:absolute; left:148px; top:75275px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">因为共享可变数据造成的竞争，并简单地通过使共享数据不可变来解决它</span></div>
<div class="txt" style="position:absolute; left:76px; top:75388px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">A variable declared final is unreassignable, so a variable declared</span></div>
<div class="txt" style="position:absolute; left:112px; top:75433px;"><span id="f47" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">final </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">is safe to access from multiple threads. </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">final</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">变量不允许再赋</span></div>
<div class="txt" style="position:absolute; left:112px; top:75481px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">值，所以声明为</span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">final</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">的变量可以安全地从多个线程访问。</span></div>
<div class="txt" style="position:absolute; left:112px; top:75551px;"><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">You can only read the variable, not write it.</span></div>
<div class="txt" style="position:absolute; left:112px; top:75611px;"><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Because this safety applies only to the variable itself, and we still have to</span></div>
<div class="txt" style="position:absolute; left:148px; top:75651px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">argue that the object the variable points to is immutable. </span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">因为这种安全性</span></div>
<div class="txt" style="position:absolute; left:148px; top:75694px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">只适用于变量本身，仍然必须确保变量指向的对象是不可变的。</span></div>
<img id="background" style="position:absolute; left:0px; top:76018px;" width="1440" height="1080" src="page65.png"> <img id="background" style="position:absolute; left:1440px; top:76018px;" width="1440" height="1080" src="page-000065.png">
<div class="txt" style="position:absolute; left:33px; top:76125px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 2: Immutability</span></div>
<div class="txt" style="position:absolute; left:899px; top:76036px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:76265px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Immutable objects are </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">usually </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">also threadsafe.</span></div>
<div class="txt" style="position:absolute; left:76px; top:76337px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">We say “</span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">usually</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">” here because our current definition of</span></div>
<div class="txt" style="position:absolute; left:112px; top:76387px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">immutability is too loose for concurrent programming.</span></div>
<div class="txt" style="position:absolute; left:76px; top:76457px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">Recall immutability in Chapter 3.3</span></div>
<div class="txt" style="position:absolute; left:112px; top:76524px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">A type is immutable if an object of the type always represents the same</span></div>
<div class="txt" style="position:absolute; left:148px; top:76563px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">abstract value for its entire lifetime. </span><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">类型是不可变的</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">: </span><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">如果类型的对象在其</span></div>
<div class="txt" style="position:absolute; left:148px; top:76606px;"><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">整个生命周期中始终表示相同的抽象值</span></div>
<div class="txt" style="position:absolute; left:112px; top:76671px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">But that actually allows the type the freedom to mutate its rep, as long as</span></div>
<div class="txt" style="position:absolute; left:148px; top:76710px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">those mutations are invisible to clients, such as </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">beneficent mutation.</span><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">但实际</span></div>
<div class="txt" style="position:absolute; left:148px; top:76753px;"><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">上，允许对</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">rep</span><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">进行改变，只要这些改变对客户是不可见的，并且对应的抽</span></div>
<div class="txt" style="position:absolute; left:148px; top:76797px;"><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">象值不变，例如有益的变化</span></div>
<div class="txt" style="position:absolute; left:76px; top:76866px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">For concurrency, this kind of hidden mutation is not safe.</span></div>
<div class="txt" style="position:absolute; left:112px; top:76933px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">An immutable data type that uses beneficent mutation will have to make</span></div>
<div class="txt" style="position:absolute; left:148px; top:76972px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">itself threadsafe using locks. </span><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">但是对于并发编程，这种隐藏的变化是不安全</span></div>
<div class="txt" style="position:absolute; left:148px; top:77015px;"><span id="f34" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">的， 使用有益的变化的不可变数据类型必须使用锁使自己线程安全</span></div>
<img id="background" style="position:absolute; left:0px; top:77205px;" width="1440" height="1080" src="page66.png"> <img id="background" style="position:absolute; left:1440px; top:77205px;" width="1440" height="1080" src="page-000066.png">
<div class="txt" style="position:absolute; left:33px; top:77312px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 2: Immutability</span></div>
<div class="txt" style="position:absolute; left:76px; top:77452px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Recall the examples in 3.3</span></div>
<div class="txt" style="position:absolute; left:899px; top:77223px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<img id="background" style="position:absolute; left:0px; top:78392px;" width="1440" height="1080" src="page67.png"> <img id="background" style="position:absolute; left:1440px; top:78392px;" width="1440" height="1080" src="page-000067.png">
<div class="txt" style="position:absolute; left:899px; top:78410px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:78499px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Stronger definition of immutability</span></div>
<div class="txt" style="position:absolute; left:76px; top:78639px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">In order to be confident that an immutable data type is threadsafe</span></div>
<div class="txt" style="position:absolute; left:112px; top:78689px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">without locks, we need a </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">stronger definition of immutability:</span></div>
<div class="txt" style="position:absolute; left:112px; top:78750px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">No mutator methods </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">没有改变数据的操作</span></div>
<div class="txt" style="position:absolute; left:112px; top:78810px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">All fields are private and final </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">所有的字段均为</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">private </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">和 </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">final</span></div>
<div class="txt" style="position:absolute; left:112px; top:78871px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">No representation exposure </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">没有表示泄露</span></div>
<div class="txt" style="position:absolute; left:112px; top:78935px;"><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">No mutation whatsoever of mutable objects in the rep </span><span id="f46" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">not</span></div>
<div class="txt" style="position:absolute; left:148px; top:78974px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">even beneficent mutation </span><span id="f27" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">表示中的任何可变对象都不能变化</span></div>
<div class="txt" style="position:absolute; left:76px; top:79044px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">If you follow these rules, then you can be confident that your</span></div>
<div class="txt" style="position:absolute; left:112px; top:79094px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">immutable type will also be threadsafe.</span></div>
<img id="background" style="position:absolute; left:0px; top:79579px;" width="1440" height="1080" src="page68.png"> <img id="background" style="position:absolute; left:1440px; top:79579px;" width="1440" height="1080" src="page-000068.png">
<div class="txt" style="position:absolute; left:899px; top:79597px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:79686px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Stronger definition of immutability</span></div>
<div class="txt" style="position:absolute; left:76px; top:79825px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Don't provide "</span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">setter</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">" methods </span><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">— </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">methods that modify fields or objects</span></div>
<div class="txt" style="position:absolute; left:112px; top:79870px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">referred to by fields.</span></div>
<div class="txt" style="position:absolute; left:76px; top:79933px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Make all fields </span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">final </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">and </span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">private</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">.</span></div>
<div class="txt" style="position:absolute; left:76px; top:79998px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Don't allow subclasses to </span><span id="f17" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">override </span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">methods.</span></div>
<div class="txt" style="position:absolute; left:112px; top:80055px;"><span id="f34" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">The simplest way to do this is to declare the class as </span><span id="f17" style="font-size:14px;vertical-align:baseline;color:rgba(255,0,0,1);">final</span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">. </span><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">类声明为</span><span id="f15" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">final</span></div>
<div class="txt" style="position:absolute; left:112px; top:80111px;"><span id="f34" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">A more sophisticated approach is to make the constructor </span><span id="f17" style="font-size:14px;vertical-align:baseline;color:rgba(255,0,0,1);">private </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">and construct</span></div>
<div class="txt" style="position:absolute; left:148px; top:80147px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">instances in </span><span id="f17" style="font-size:14px;vertical-align:baseline;color:rgba(255,0,0,1);">factory methods</span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">.</span><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">更复杂的方法是使构造函数为私有，并使用工厂方法</span></div>
<div class="txt" style="position:absolute; left:148px; top:80185px;"><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">构造实例。</span></div>
<div class="txt" style="position:absolute; left:76px; top:80247px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f20" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">If the instance fields include references to mutable objects, don‘t allow</span></div>
<div class="txt" style="position:absolute; left:112px; top:80291px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">those objects to be changed:</span><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">如果成员变量包含对可变对象的引用，不要允许更改</span></div>
<div class="txt" style="position:absolute; left:112px; top:80331px;"><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">这些对象</span></div>
<div class="txt" style="position:absolute; left:112px; top:80385px;"><span id="f34" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Don't provide methods that modify the mutable objects.</span><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">不提供修改可变对象的方法</span></div>
<div class="txt" style="position:absolute; left:112px; top:80439px;"><span id="f34" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f76" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Don‘t share references to the mutable objects. </span><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">不要共享对可变对象的引用</span></div>
<div class="txt" style="position:absolute; left:148px; top:80492px;"><span id="f76" style="font-size:28px;vertical-align:baseline;color:rgba(255,130,44,1);">• </span><span id="f8" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,0,1);">Never store references to external, mutable objects passed to the constructor; if necessary,</span></div>
<div class="txt" style="position:absolute; left:184px; top:80522px;"><span id="f8" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,0,1);">create copies, and store references to the copies.</span><span id="f40" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,255,1);">不存储传递给构造函数的外部可变对象的引用</span></div>
<div class="txt" style="position:absolute; left:148px; top:80566px;"><span id="f76" style="font-size:28px;vertical-align:baseline;color:rgba(255,130,44,1);">• </span><span id="f8" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,0,1);">Similarly, create copies of your internal mutable objects when necessary to avoid returning</span></div>
<div class="txt" style="position:absolute; left:184px; top:80597px;"><span id="f8" style="font-size:28px;vertical-align:baseline;color:rgba(0,0,0,1);">the originals in your methods.</span><span id="f40" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">避免在方法返回值中包含对可变对象的引用</span></div>
<img id="background" style="position:absolute; left:0px; top:80766px;" width="1440" height="1080" src="page69.png"> <img id="background" style="position:absolute; left:1440px; top:80766px;" width="1440" height="1080" src="page-000069.png">
<div class="txt" style="position:absolute; left:1105px; top:80784px;"><span id="f9" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Software Construction</span></div>
<div class="txt" style="position:absolute; left:177px; top:81095px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 3: Using Threadsafe Data</span></div>
<div class="txt" style="position:absolute; left:623px; top:81181px;"><span id="f9" style="font-size:72px;vertical-align:baseline;color:rgba(0,0,0,1);">Types</span></div>
<img id="background" style="position:absolute; left:0px; top:81953px;" width="1440" height="1080" src="page70.png"> <img id="background" style="position:absolute; left:1440px; top:81953px;" width="1440" height="1080" src="page-000070.png">
<div class="txt" style="position:absolute; left:899px; top:81971px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:82060px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Strategy 3: Using Threadsafe Data Types</span></div>
<div class="txt" style="position:absolute; left:76px; top:82200px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The third major strategy for achieving thread safety is </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">to store</span></div>
<div class="txt" style="position:absolute; left:112px; top:82245px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">shared mutable data in existing threadsafe data types. </span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">将共享的可</span></div>
<div class="txt" style="position:absolute; left:112px; top:82293px;"><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">变数据存储在线程安全的数据类型中。</span></div>
<div class="txt" style="position:absolute; left:76px; top:82416px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">When a data type in the Java library is threadsafe, its documentation</span></div>
<div class="txt" style="position:absolute; left:112px; top:82461px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">will explicitly state that fact. </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Java</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">类库中线程安全的数据类型，会显</span></div>
<div class="txt" style="position:absolute; left:112px; top:82509px;"><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">式地声明</span></div>
<div class="txt" style="position:absolute; left:76px; top:82656px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f44" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">It’s become common in the Java API to find two mutable data types</span></div>
<div class="txt" style="position:absolute; left:112px; top:82706px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">that do the same thing, one threadsafe and the other not.</span></div>
<div class="txt" style="position:absolute; left:76px; top:82776px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The reason is what this quote indicates: </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">threadsafe data types</span></div>
<div class="txt" style="position:absolute; left:112px; top:82826px;"><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">usually incur a performance penalty compared to an unsafe type.</span></div>
<div class="txt" style="position:absolute; left:112px; top:82869px;"><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">因为线程安全的数据类型性能较差，所以</span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Java</span><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">对一些可变数据类型提</span></div>
<div class="txt" style="position:absolute; left:112px; top:82917px;"><span id="f22" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">供两种形式供选择：线程安全的和线程不安全的。</span></div>
<img id="background" style="position:absolute; left:0px; top:83140px;" width="1440" height="1080" src="page71.png"> <img id="background" style="position:absolute; left:1440px; top:83140px;" width="1440" height="1080" src="page-000071.png">
<div class="txt" style="position:absolute; left:899px; top:83158px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:33px; top:83247px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">An example: </span><span id="f13" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,255,1);">StringBuffer vs. StringBuilder</span></div>
<div class="txt" style="position:absolute; left:76px; top:83386px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">[StringBuffer is] A thread-safe, mutable</span></div>
<div class="txt" style="position:absolute; left:112px; top:83425px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">sequence of characters. A string buffer is</span></div>
<div class="txt" style="position:absolute; left:112px; top:83464px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">like a String, but can be modified. At</span></div>
<div class="txt" style="position:absolute; left:112px; top:83502px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">any point in time it contains some</span></div>
<div class="txt" style="position:absolute; left:112px; top:83541px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">particular sequence of characters, but</span></div>
<div class="txt" style="position:absolute; left:112px; top:83579px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">the length and content of the sequence</span></div>
<div class="txt" style="position:absolute; left:112px; top:83618px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">can be changed through certain method</span></div>
<div class="txt" style="position:absolute; left:112px; top:83656px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">calls.</span></div>
<div class="txt" style="position:absolute; left:76px; top:83712px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">String buffers are safe for use by</span></div>
<div class="txt" style="position:absolute; left:112px; top:83752px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">multiple threads. The methods are</span></div>
<div class="txt" style="position:absolute; left:112px; top:83790px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">synchronized where necessary so that</span></div>
<div class="txt" style="position:absolute; left:112px; top:83829px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">all the operations on any particular</span></div>
<div class="txt" style="position:absolute; left:112px; top:83867px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">instance behave as if they occur in some</span></div>
<div class="txt" style="position:absolute; left:112px; top:83906px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">serial order that is consistent with the</span></div>
<div class="txt" style="position:absolute; left:112px; top:83944px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">order of the method calls made by each</span></div>
<div class="txt" style="position:absolute; left:112px; top:83982px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">of the individual threads involved.</span></div>
<div class="txt" style="position:absolute; left:779px; top:83386px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">[StringBuilder is] A mutable sequence of</span></div>
<div class="txt" style="position:absolute; left:815px; top:83425px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">characters. This class provides an API</span></div>
<div class="txt" style="position:absolute; left:815px; top:83464px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">compatible with StringBuffer, but with</span></div>
<div class="txt" style="position:absolute; left:815px; top:83502px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">no guarantee of synchronization.</span></div>
<div class="txt" style="position:absolute; left:779px; top:83559px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">This class is designed for use as a drop-</span></div>
<div class="txt" style="position:absolute; left:815px; top:83598px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">in replacement for StringBuffer in places</span></div>
<div class="txt" style="position:absolute; left:815px; top:83637px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">where the string buffer was being used</span></div>
<div class="txt" style="position:absolute; left:815px; top:83675px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">by a single thread (as is generally the</span></div>
<div class="txt" style="position:absolute; left:815px; top:83714px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">case).</span></div>
<div class="txt" style="position:absolute; left:779px; top:83770px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">Where possible, it is recommended that</span></div>
<div class="txt" style="position:absolute; left:815px; top:83810px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">this class be used in preference to</span></div>
<div class="txt" style="position:absolute; left:815px; top:83848px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">StringBuffer as it will be faster under</span></div>
<div class="txt" style="position:absolute; left:815px; top:83886px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">most implementations.</span></div>
<div class="txt" style="position:absolute; left:261px; top:84053px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">StringBuffer </span><span id="f214" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">和 </span><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">StringBuilder</span><span id="f214" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">都是可变数据类型，功能基本相同</span></div>
<div class="txt" style="position:absolute; left:261px; top:84096px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">StringBuffer</span><span id="f214" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">是线程安全的，</span><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">StringBuilder</span><span id="f214" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">不是</span></div>
<div class="txt" style="position:absolute; left:261px; top:84142px;"><span id="f17" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">StringBuilder</span><span id="f214" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">性能更好，推荐在单线程程序中使用</span></div>
<img id="background" style="position:absolute; left:0px; top:84327px;" width="1440" height="1080" src="page72.png"> <img id="background" style="position:absolute; left:1440px; top:84327px;" width="1440" height="1080" src="page-000072.png">
<div class="txt" style="position:absolute; left:33px; top:84434px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Threadsafe Collections</span></div>
<div class="txt" style="position:absolute; left:899px; top:84345px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:54px; top:84563px;"><span id="f12" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The collection interfaces in Java </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f18" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">List </span><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">, </span><span id="f18" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">Set </span><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">, </span><span id="f18" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">Map </span><span id="f16" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">– </span><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">have basic</span></div>
<div class="txt" style="position:absolute; left:90px; top:84612px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">implementations that are not threadsafe.</span></div>
<div class="txt" style="position:absolute; left:90px; top:84677px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The implementations namely </span><span id="f18" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">ArrayList </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, </span><span id="f18" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">HashMap </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, and </span><span id="f18" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">HashSet </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, cannot be</span></div>
<div class="txt" style="position:absolute; left:126px; top:84717px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">used safely from more than one thread. </span><span id="f40" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">这些不是线程安全的类型</span></div>
<div class="txt" style="position:absolute; left:54px; top:84786px;"><span id="f12" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Just like the Collections API provides wrapper methods that make</span></div>
<div class="txt" style="position:absolute; left:90px; top:84836px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">collections immutable, it provides another set of wrapper methods to</span></div>
<div class="txt" style="position:absolute; left:90px; top:84880px;"><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">make collections threadsafe, while still mutable. </span><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Java</span><span id="f40" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">提供了线程安全</span></div>
<div class="txt" style="position:absolute; left:90px; top:84928px;"><span id="f40" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">的</span><span id="f14" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">Collections</span><span id="f40" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">类型版本。</span></div>
<div class="txt" style="position:absolute; left:90px; top:84997px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">These wrappers effectively make each method of the collection atomic with</span></div>
<div class="txt" style="position:absolute; left:126px; top:85036px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">respect to the other methods. </span><span id="f40" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">确保方法是原子的</span></div>
<div class="txt" style="position:absolute; left:90px; top:85101px;"><span id="f29" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">An atomic action effectively happens all at once </span><span id="f67" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">– it doesn’t interleave its</span></div>
<div class="txt" style="position:absolute; left:126px; top:85144px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">internal operations with those of other actions, and none of the effects of the</span></div>
<div class="txt" style="position:absolute; left:126px; top:85187px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">action are visible to other threads until the entire action is complete, so it</span></div>
<div class="txt" style="position:absolute; left:126px; top:85227px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">never looks partially done. </span><span id="f40" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">原子方法：动作的内部操作不会同其他操作交叉，</span></div>
<div class="txt" style="position:absolute; left:126px; top:85270px;"><span id="f40" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">不会产生部分完成的情况</span></div>
<div class="txt" style="position:absolute; left:177px; top:85318px;"><span id="f18" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">private static Map&lt;Integer,Boolean&gt; cache =</span></div>
<div class="txt" style="position:absolute; left:374px; top:85361px;"><span id="f18" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Collections.synchronizedMap(new </span><span id="f18" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">HashMap&lt;&gt;());</span></div>
<img id="background" style="position:absolute; left:0px; top:85514px;" width="1440" height="1080" src="page73.png"> <img id="background" style="position:absolute; left:1440px; top:85514px;" width="1440" height="1080" src="page-000073.png">
<div class="txt" style="position:absolute; left:33px; top:85621px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Threadsafe wrappers</span></div>
<div class="txt" style="position:absolute; left:899px; top:85532px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:56px; top:85749px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Wrapper implementations delegate all their real work to a specified</span></div>
<div class="txt" style="position:absolute; left:92px; top:85799px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">collection but add extra functionality on top of what this collection</span></div>
<div class="txt" style="position:absolute; left:92px; top:85843px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">offers. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">包装的实现是将所有的实际工作委托给指定的容器，但在容器</span></div>
<div class="txt" style="position:absolute; left:92px; top:85891px;"><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">的基础上添加额外的功能。</span></div>
<div class="txt" style="position:absolute; left:56px; top:85963px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">This is an example of the decorator pattern</span><span id="f25" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">装饰者模式的一个例子</span></div>
<div class="txt" style="position:absolute; left:56px; top:86038px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">These implementations are anonymous; rather than providing a</span></div>
<div class="txt" style="position:absolute; left:92px; top:86083px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">public class, the library provides a static factory method</span><span id="f25" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">. </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">不提供</span></div>
<div class="txt" style="position:absolute; left:92px; top:86131px;"><span id="f25" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">public class, </span><span id="f19" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">只提供静态工厂方法</span></div>
<div class="txt" style="position:absolute; left:56px; top:86206px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">All these implementations are found in the Collections class, which</span></div>
<div class="txt" style="position:absolute; left:92px; top:86255px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">consists solely of static methods.</span></div>
<div class="txt" style="position:absolute; left:144px; top:86329px;"><span id="f57" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">private static Map&lt;Integer,Boolean&gt; cache =</span></div>
<div class="txt" style="position:absolute; left:342px; top:86372px;"><span id="f57" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">Collections.synchronizedMap(new </span><span id="f57" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">HashMap&lt;&gt;());</span></div>
<div class="txt" style="position:absolute; left:56px; top:86453px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The synchronization wrappers add automatic synchronization</span></div>
<div class="txt" style="position:absolute; left:92px; top:86503px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">(thread-safety) to an arbitrary collection. </span><span id="f19" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">同步包装将自动同步（线程安全）</span></div>
<div class="txt" style="position:absolute; left:92px; top:86546px;"><span id="f19" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,255,1);">添加到指定集合</span></div>
<img id="background" style="position:absolute; left:0px; top:86701px;" width="1440" height="1080" src="page74.png"> <img id="background" style="position:absolute; left:1440px; top:86701px;" width="1440" height="1080" src="page-000074.png">
<div class="txt" style="position:absolute; left:33px; top:86808px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">Threadsafe wrappers</span></div>
<div class="txt" style="position:absolute; left:899px; top:86719px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:53px; top:86948px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Wrappers:</span></div>
<div class="txt" style="position:absolute; left:90px; top:87013px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">public static &lt;T&gt; Collection&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronizedCollection(Collection&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">c);</span></div>
<div class="txt" style="position:absolute; left:90px; top:87067px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">public static &lt;T&gt; Set&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronizedSet(Set&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">s);</span></div>
<div class="txt" style="position:absolute; left:90px; top:87120px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">public static &lt;T&gt; List&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronizedList(List&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">list);</span></div>
<div class="txt" style="position:absolute; left:90px; top:87174px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">public static &lt;K,V&gt; Map&lt;K,V&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronizedMap(Map&lt;K,V&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">m);</span></div>
<div class="txt" style="position:absolute; left:90px; top:87228px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">public static &lt;T&gt; SortedSet&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronizedSortedSet(SortedSet&lt;T&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">s);</span></div>
<div class="txt" style="position:absolute; left:90px; top:87282px;"><span id="f17" style="font-size:31px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">public static &lt;K,V&gt; SortedMap&lt;K,V&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronizedSortedMap(SortedMap&lt;K,V&gt; </span><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">m);</span></div>
<div class="txt" style="position:absolute; left:53px; top:87342px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Usage:</span></div>
<div class="txt" style="position:absolute; left:90px; top:87407px;"><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">List&lt;Type&gt; c = Collections.synchronizedList(new ArrayList&lt;Type&gt;());</span></div>
<div class="txt" style="position:absolute; left:90px; top:87461px;"><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">synchronized(c) { </span><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(255,0,0,1);">// to be introduced later (the 4-th threadsafe way)</span></div>
<div class="txt" style="position:absolute; left:160px; top:87515px;"><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">for (Type e : c)</span></div>
<div class="txt" style="position:absolute; left:230px; top:87569px;"><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">foo(e);</span></div>
<div class="txt" style="position:absolute; left:90px; top:87623px;"><span id="f19" style="font-size:14px;vertical-align:baseline;color:rgba(0,0,0,1);">}</span></div>
<img id="background" style="position:absolute; left:0px; top:87888px;" width="1440" height="1080" src="page75.png"> <img id="background" style="position:absolute; left:1440px; top:87888px;" width="1440" height="1080" src="page-000075.png">
<div class="txt" style="position:absolute; left:33px; top:87995px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">A few points</span></div>
<div class="txt" style="position:absolute; left:899px; top:87906px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:88132px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Don’t circumvent the wrapper. </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">不要绕开包装类</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">,</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">统一采用包装类的形式</span></div>
<div class="txt" style="position:absolute; left:112px; top:88202px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Make sure to throw away references to the underlying non-threadsafe</span></div>
<div class="txt" style="position:absolute; left:148px; top:88241px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">collection, and access it only through the synchronized wrapper.</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">确保抛弃对底</span></div>
<div class="txt" style="position:absolute; left:148px; top:88287px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">层非线程安全容器类的引用，并只通过同步的包装类来访问它。</span></div>
<div class="txt" style="position:absolute; left:112px; top:88354px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The new </span><span id="f45" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">HashMap </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">is passed only to </span><span id="f45" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">synchronizedMap() </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">and never stored</span></div>
<div class="txt" style="position:absolute; left:148px; top:88393px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">anywhere else.</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">新的</span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">HashMap</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">只传递给</span><span id="f21" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">synchronizedMap</span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">，并且永远不会存储</span></div>
<div class="txt" style="position:absolute; left:148px; top:88437px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">在其他地方</span></div>
<div class="txt" style="position:absolute; left:112px; top:88501px;"><span id="f25" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The underlying collection is still mutable, and code with a reference to it can</span></div>
<div class="txt" style="position:absolute; left:148px; top:88540px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">circumvent immutability. </span><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">因为底层的容器仍然是可变的，引用它的代码可以</span></div>
<div class="txt" style="position:absolute; left:148px; top:88584px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">规避不变性，失去了包装的意义</span></div>
<img id="background" style="position:absolute; left:0px; top:89075px;" width="1440" height="1080" src="page76.png"> <img id="background" style="position:absolute; left:1440px; top:89075px;" width="1440" height="1080" src="page-000076.png">
<div class="txt" style="position:absolute; left:33px; top:89182px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">A few points</span></div>
<div class="txt" style="position:absolute; left:899px; top:89093px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:89322px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Iterators are still not threadsafe.</span></div>
<div class="txt" style="position:absolute; left:112px; top:89388px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Even though method calls on the collection itself ( </span><span id="f22" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">get(), put(), add()</span></div>
<div class="txt" style="position:absolute; left:148px; top:89432px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">, etc.) are now threadsafe, iterators created from the collection are still not</span></div>
<div class="txt" style="position:absolute; left:148px; top:89475px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">threadsafe.</span></div>
<div class="txt" style="position:absolute; left:112px; top:89535px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">So you </span><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">can’t use </span><span id="f22" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">iterator() </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">, or the </span><span id="f22" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">for </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">loop syntax:</span></div>
<div class="txt" style="position:absolute; left:195px; top:89600px;"><span id="f22" style="font-size:15px;vertical-align:baseline;color:rgba(0,0,0,1);">for (String s: lst) { ... }</span></div>
<div class="txt" style="position:absolute; left:220px; top:89643px;"><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">// </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">not threadsafe, even if </span><span id="f22" style="font-size:15px;vertical-align:baseline;color:rgba(255,0,0,1);">lst </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(255,0,0,1);">is a synchronized list wrapper</span></div>
<div class="txt" style="position:absolute; left:112px; top:89704px;"><span id="f19" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">The solution to this iteration problem will be to acquire the collection’s</span></div>
<div class="txt" style="position:absolute; left:148px; top:89743px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">lock when you need to iterate over it. </span><span id="f56" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">解决方案将是在需要迭代</span><span id="f15" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">collection</span></div>
<div class="txt" style="position:absolute; left:148px; top:89786px;"><span id="f56" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">时获取它的锁</span></div>
<img id="background" style="position:absolute; left:0px; top:90262px;" width="1440" height="1080" src="page77.png"> <img id="background" style="position:absolute; left:1440px; top:90262px;" width="1440" height="1080" src="page-000077.png">
<div class="txt" style="position:absolute; left:33px; top:90369px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">A few points</span></div>
<div class="txt" style="position:absolute; left:899px; top:90280px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:90509px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Atomic operations aren’t enough to prevent races: the way that you</span></div>
<div class="txt" style="position:absolute; left:112px; top:90554px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">use the synchronized collection can still have a race condition</span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">.</span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">原子操</span></div>
<div class="txt" style="position:absolute; left:112px; top:90602px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">作不足以完全防止竞争</span></div>
<div class="txt" style="position:absolute; left:76px; top:90749px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Consider this code, which checks whether a list has at least one</span></div>
<div class="txt" style="position:absolute; left:112px; top:90794px;"><span id="f18" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">element and then gets that element: </span><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">例如检查列表是否至少有一个元</span></div>
<div class="txt" style="position:absolute; left:112px; top:90842px;"><span id="f21" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,255,1);">素，然后获取该元素</span></div>
<div class="txt" style="position:absolute; left:180px; top:90919px;"><span id="f38" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">if (!lst.isEmpty()) {String s = lst.get(0); ... }</span></div>
<div class="txt" style="position:absolute; left:76px; top:90989px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Even if you make </span><span id="f38" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">lst </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">into a synchronized list, this code still may</span></div>
<div class="txt" style="position:absolute; left:112px; top:91039px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">have a race condition, because </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">another thread may remove the</span></div>
<div class="txt" style="position:absolute; left:112px; top:91086px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">element between the </span><span id="f38" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">isEmpty() </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">call and the </span><span id="f38" style="font-size:26px;vertical-align:baseline;color:rgba(255,0,0,1);">get()</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(255,0,0,1);">call.</span></div>
<img id="background" style="position:absolute; left:0px; top:91449px;" width="1440" height="1080" src="page78.png"> <img id="background" style="position:absolute; left:1440px; top:91449px;" width="1440" height="1080" src="page-000078.png">
<div class="txt" style="position:absolute; left:33px; top:91556px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">A few points</span></div>
<div class="txt" style="position:absolute; left:899px; top:91467px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:91912px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">The synchronized map ensures that </span><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">containsKey()</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">, </span><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">get()</span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">, and</span></div>
<div class="txt" style="position:absolute; left:112px; top:91961px;"><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">put() </span><span id="f23" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">are now atomic, so using them from multiple threads won’t</span></div>
<div class="txt" style="position:absolute; left:112px; top:92010px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">damage the rep invariant of the map.</span></div>
<div class="txt" style="position:absolute; left:76px; top:92080px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">But those three operations can now interleave in arbitrary ways with</span></div>
<div class="txt" style="position:absolute; left:112px; top:92129px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">each other, which might break the invariant that </span><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">isPrime </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">needs from</span></div>
<div class="txt" style="position:absolute; left:112px; top:92177px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">the cache: If the cache maps an integer </span><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">x </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">to a value </span><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">f </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">, then </span><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">x </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">is prime</span></div>
<div class="txt" style="position:absolute; left:112px; top:92225px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">if and only if </span><span id="f16" style="font-size:26px;vertical-align:baseline;color:rgba(0,0,0,1);">f </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">is true.</span></div>
<div class="txt" style="position:absolute; left:76px; top:92296px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">If the cache ever fails this invariant, then we might return the wrong</span></div>
<div class="txt" style="position:absolute; left:112px; top:92346px;"><span id="f8" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">result.</span></div>
<div class="txt" style="position:absolute; left:76px; top:92411px;"><span id="f13" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f47" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">Synchronied map </span><span id="f52" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">能够保证各操作是原子的，但是操作间的交叉仍然会破坏</span></div>
<div class="txt" style="position:absolute; left:112px; top:92455px;"><span id="f52" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,255,1);">不变性</span></div>
<img id="background" style="position:absolute; left:0px; top:92636px;" width="1440" height="1080" src="page79.png"> <img id="background" style="position:absolute; left:1440px; top:92636px;" width="1440" height="1080" src="page-000079.png">
<div class="txt" style="position:absolute; left:33px; top:92743px;"><span id="f8" style="font-size:60px;vertical-align:baseline;color:rgba(0,0,0,1);">A short summary</span></div>
<div class="txt" style="position:absolute; left:899px; top:92654px;"><span id="f8" style="font-size:31px;vertical-align:baseline;color:rgba(0,0,0,1);">10.1 Concurrency and Thread-Safety</span></div>
<div class="txt" style="position:absolute; left:76px; top:92883px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Three major ways to achieve safety from race conditions on shared</span></div>
<div class="txt" style="position:absolute; left:112px; top:92933px;"><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">mutable data:</span></div>
<div class="txt" style="position:absolute; left:112px; top:92998px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Confinement: not sharing the data.</span></div>
<div class="txt" style="position:absolute; left:112px; top:93058px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Immutability: sharing, but keeping the data immutable.</span></div>
<div class="txt" style="position:absolute; left:112px; top:93119px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">Threadsafe data types: storing the shared mutable data in a single</span></div>
<div class="txt" style="position:absolute; left:148px; top:93162px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">threadsafe datatype.</span></div>
<div class="txt" style="position:absolute; left:76px; top:93300px;"><span id="f13" style="font-size:40px;vertical-align:baseline;color:rgba(255,130,44,1);">▪ </span><span id="f15" style="font-size:40px;vertical-align:baseline;color:rgba(0,0,0,1);">Safe from bugs.</span></div>
<div class="txt" style="position:absolute; left:112px; top:93366px;"><span id="f18" style="font-size:36px;vertical-align:baseline;color:rgba(255,130,44,1);">– </span><span id="f31" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">We’re trying to eliminate a major class of concurrency bugs, race</span></div>
<div class="txt" style="position:absolute; left:148px; top:93410px;"><span id="f8" style="font-size:36px;vertical-align:baseline;color:rgba(0,0,0,1);">conditions, and eliminate them by design, not just by accident of timing.</span></div>
</body></html>